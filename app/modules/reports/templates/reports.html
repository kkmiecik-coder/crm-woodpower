<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Raport sprzeda≈ºowy - Wood Power CRM</title>
    <link rel="icon" href="{{ url_for('static', filename='images/favicon.png') }}" type="image/png">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('reports.static', filename='css/reports.css') }}">

    <!-- Font Awesome dla ikon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts - Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="app-container">
        {% include 'sidebar/sidebar.html' %}

        <main class="main-content">
            <!-- Nag≈Ç√≥wek -->
            <div class="reports-header">
                <h1 class="title-with-underline">Raport sprzeda≈ºowy</h1>

                <!-- Kontrolki -->
                <div class="reports-controls">

                    <!-- Przycisk synchronizacji -->
                    <div class="sync-section">
                        <button id="syncBtn" class="btn btn-primary">
                            <i class="fas fa-download"></i>
                            Pobierz zam√≥wienia
                        </button>
                        {% if has_new_orders %}
                        <div class="new-orders-badge">
                            {% if api_limit_reached %}
                            {{ new_orders_count }} lub wiƒôcej nowych zam√≥wie≈Ñ
                            {% else %}
                            {{ new_orders_count }} nowych zam√≥wie≈Ñ
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>

                    <!-- Synchronizacja status√≥w -->
                    <button id="syncStatusesBtn" class="btn btn-warning"
                            title="Synchronizuje wszystkie informacje z zam√≥wie≈Ñ (statusy, kwoty zap≈Çacone, dane produkt√≥w) dla wszystkich zam√≥wie≈Ñ z Baselinker - wykluczajƒÖc tylko anulowane i nieop≈Çacone">
                        <i class="fas fa-refresh"></i>
                        Synchronizuj zam√≥wienia
                    </button>

                    <!-- Przycisk dodania rƒôcznego wiersza -->
                    <button id="addManualRowBtn" class="btn btn-success">
                        <i class="fas fa-plus"></i>
                        Dodaj wiersz
                    </button>

                    <!-- Przycisk eksportu -->
                    <div class="dropdown export-dropdown">
                        <button id="exportBtn" class="btn btn-info dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-download"></i>
                            Export
                        </button>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item" href="#" id="exportExcelOption">
                                    <i class="fas fa-file-excel"></i>
                                    Excel
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#" id="exportRoutimoOption">
                                    <i class="fas fa-route"></i>
                                    Routimo
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Statystyki -->
            <div class="stats-container">
                <div class="stat-box">
                    <div class="stat-label">TTL m¬≥</div>
                    <div class="stat-value" id="statTotalM3">0.00</div>
                    <div class="stat-comparison" id="compTotalM3"></div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Warto≈õƒá produkt√≥w netto</div>
                    <div class="stat-value" id="statOrderAmountNet">0.00 z≈Ç</div>
                    <div class="stat-comparison" id="compOrderAmountNet"></div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">≈örednia cena netto m¬≥</div>
                    <div class="stat-value" id="statPricePerM3">0.00 z≈Ç</div>
                    <div class="stat-comparison" id="compPricePerM3"></div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Koszt dostawy netto</div>
                    <div class="stat-value" id="statDeliveryCostNet">0.00 z≈Ç</div>
                    <div class="stat-comparison" id="compDeliveryCostNet"></div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Zap≈Çacono TTL netto</div>
                    <div class="stat-value" id="statPaidAmountNet">0.00 z≈Ç</div>
                    <div class="stat-comparison" id="compPaidAmountNet"></div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Ilo≈õƒá m¬≥ w produkcji</div>
                    <div class="stat-value" id="statProductionVolume">0.00</div>
                    <div class="stat-comparison" id="compProductionVolume"></div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Warto≈õƒá netto w produkcji</div>
                    <div class="stat-value" id="statProductionValueNet">0.00 z≈Ç</div>
                    <div class="stat-comparison" id="compProductionValueNet"></div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Wyprodukowane</div>
                    <div class="stat-value" id="statReadyPickupVolume">0.00</div>
                    <div class="stat-comparison" id="compReadyPickupVolume"></div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Do odebrania</div>
                    <div class="stat-value" id="statPickupReady">0.00</div>
                    <div class="stat-comparison" id="compPickupReady"></div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Do zap≈Çaty netto</div>
                    <div class="stat-value" id="statBalanceDue">0.00 z≈Ç</div>
                    <div class="stat-comparison" id="compBalanceDue"></div>
                </div>
                <!-- do usuniƒôcia -->
            </div>

            <!-- Loading overlay -->
            <div id="loadingOverlay" class="loading-overlay hidden">
                <div class="spinner"></div>
                <div class="loading-text">Pobieranie danych...</div>
            </div>

            <!-- Tabela raport√≥w -->
            <div class="reports-table-container">
                <!-- Filtry kolumn -->
                <div class="column-filters">
                    <div class="filter-row">
                        <!-- Filtry dat (bez zmian) -->
                        <div class="filter-item">
                            <label>Zakres dat:</label>
                            <div class="date-range-container">
                                <input type="date" id="filterDateFrom" class="date-input" placeholder="Od">
                                <input type="date" id="filterDateTo" class="date-input" placeholder="Do">
                            </div>
                        </div>

                        <!-- NOWY FILTR KLIENT√ìW - DROPDOWN -->
                        <div class="filter-item">
                            <label>Klienci:</label>
                            <div class="filter-dropdown" id="filterCustomerNameDropdown">
                                <div class="filter-dropdown-toggle" id="filterCustomerNameToggle">
                                    <span class="filter-dropdown-label">Wszyscy klienci</span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="filter-dropdown-menu" id="filterCustomerNameMenu">
                                    <div class="filter-search">
                                        <input type="text" id="searchCustomerName" placeholder="Szukaj klienta..." class="filter-search-input">
                                    </div>
                                    <div class="filter-options" id="filterCustomerNameOptions">
                                        <!-- Opcje ≈Çadowane dynamicznie -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- NOWY FILTR WOJEW√ìDZTW - DROPDOWN -->
                        <div class="filter-item">
                            <label>Wojew√≥dztwa:</label>
                            <div class="filter-dropdown" id="filterDeliveryStateDropdown">
                                <div class="filter-dropdown-toggle" id="filterDeliveryStateToggle">
                                    <span class="filter-dropdown-label">Wszystkie wojew√≥dztwa</span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="filter-dropdown-menu" id="filterDeliveryStateMenu">
                                    <div class="filter-search">
                                        <input type="text" id="searchDeliveryState" placeholder="Szukaj wojew√≥dztwo..." class="filter-search-input">
                                    </div>
                                    <div class="filter-options" id="filterDeliveryStateOptions">
                                        <!-- Opcje ≈Çadowane dynamicznie -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- NOWY FILTR GATUNK√ìW - DROPDOWN -->
                        <div class="filter-item">
                            <label>Gatunki:</label>
                            <div class="filter-dropdown" id="filterWoodSpeciesDropdown">
                                <div class="filter-dropdown-toggle" id="filterWoodSpeciesToggle">
                                    <span class="filter-dropdown-label">Wszystkie gatunki</span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="filter-dropdown-menu" id="filterWoodSpeciesMenu">
                                    <div class="filter-search">
                                        <input type="text" id="searchWoodSpecies" placeholder="Szukaj gatunek..." class="filter-search-input">
                                    </div>
                                    <div class="filter-options" id="filterWoodSpeciesOptions">
                                        <!-- Opcje ≈Çadowane dynamicznie -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- NOWY FILTR STATUS√ìW - DROPDOWN -->
                        <div class="filter-item">
                            <label>Statusy:</label>
                            <div class="filter-dropdown" id="filterCurrentStatusDropdown">
                                <div class="filter-dropdown-toggle" id="filterCurrentStatusToggle">
                                    <span class="filter-dropdown-label">Wszystkie statusy</span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="filter-dropdown-menu" id="filterCurrentStatusMenu">
                                    <div class="filter-search">
                                        <input type="text" id="searchCurrentStatus" placeholder="Szukaj status..." class="filter-search-input">
                                    </div>
                                    <div class="filter-options" id="filterCurrentStatusOptions">
                                        <!-- Opcje ≈Çadowane dynamicznie -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="filter-actions">
                        <button id="clearFiltersBtn" class="btn btn-secondary btn-sm">
                            <i class="fas fa-times"></i>
                            Wyczy≈õƒá filtry
                        </button>

                        <!-- Przycisk pe≈Çnego ekranu (ukryty w fullscreen) -->
                        <button id="fullscreenToggle" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-expand"></i>
                            <span class="fullscreen-text">Pe≈Çny ekran</span>
                        </button>

                        <!-- Przycisk eksportu dla fullscreen (widoczny tylko w fullscreen) -->
                        <div class="dropdown export-dropdown fullscreen-export-btn">
                            <button id="fullscreenExportBtn" class="btn btn-info btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-download"></i>
                                Export
                            </button>
                            <ul class="dropdown-menu">
                                <li>
                                    <a class="dropdown-item" href="#" id="fullscreenExportExcelOption">
                                        <i class="fas fa-file-excel"></i>
                                        Excel
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="#" id="fullscreenExportRoutimoOption">
                                        <i class="fas fa-route"></i>
                                        Routimo
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Aktywne filtry -->
                    <div class="active-filters" id="activeFilters" style="display: none;">
                        <div class="active-filters-label">Aktywne filtry:</div>
                        <div class="active-filters-list" id="activeFiltersList">
                            <!-- Aktywne filtry wy≈õwietlane dynamicznie -->
                        </div>
                    </div>
                </div>

                <!-- G≈Ç√≥wna tabela -->
                <div class="table-wrapper">
                    <table id="reportsTable" class="reports-table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>TTL m¬≥</th>
                                <th>Kwota netto</th>
                                <th>Nr Baselinker</th>
                                <th>Nr wew.</th>
                                <th>Imiƒô i nazwisko</th>
                                <th>Ulica</th>
                                <th>Miejscowo≈õƒá</th>
                                <th>Kod pocztowy</th>
                                <th>Wojew√≥dztwo</th>
                                <th>Telefon</th>
                                <th>Opiekun</th>
                                <th>Dostawa</th>
                                <th>≈πr√≥d≈Ço</th>
                                <th>Grupa</th>
                                <th>Rodzaj</th>
                                <th>Wyko≈Ñczenie</th>
                                <th>Gatunek</th>
                                <th>Technologia</th>
                                <th>Klasa</th>
                                <th>D≈Çugo≈õƒá</th>
                                <th>Szeroko≈õƒá</th>
                                <th>Grubo≈õƒá</th>
                                <th>Ilo≈õƒá</th>
                                <th>Cena brutto</th>
                                <th>Cena netto</th>
                                <th>Warto≈õƒá brutto</th>
                                <th>Warto≈õƒá netto</th>
                                <th>Objƒôto≈õƒá 1 szt.</th>
                                <th>Objƒôto≈õƒá TTL</th>
                                <th>Cena netto za m¬≥</th>
                                <th>Data realizacji</th>
                                <th>Status</th>
                                <th>Koszt kuriera brutto</th>
                                <th>Koszt kuriera netto</th>
                                <th>Spos√≥b p≈Çatno≈õci</th>
                                <th>Zap≈Çacono netto</th>
                                <th>Do zap≈Çaty</th>
                                <th>Ilo≈õƒá w produkcji</th>
                                <th>Warto≈õƒá w produkcji</th>
                                <th>Wyprodukowane</th>
                                <th class="sortable" data-column="pickup_ready">Do odebrania</th>
                                <th>Akcje</th>
                            </tr>
                        </thead>
                        <tbody id="reportsTableBody">
                            <!-- Dane ≈Çadowane dynamicznie -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal synchronizacji -->
    <!-- KROK 1: Modal wyboru ilo≈õci dni -->
    <div id="syncDaysModal" class="sync-modal" style="display: none;">
        <div class="sync-modal-overlay">
            <div class="sync-modal-content">
                <div class="sync-modal-header">
                    <h3>Pobierz zam√≥wienia z Baselinker</h3>
                    <button class="sync-modal-close" id="syncDaysModalClose">&times;</button>
                </div>

                <div class="sync-modal-body">
                    <div class="days-selection-container">
                        <p class="days-selection-description">
                            Wybierz zakres dat dla pobierania zam√≥wie≈Ñ z Baselinker:
                        </p>
                        
                        <div class="days-dropdown-container">
                            <label for="daysSelect" class="days-dropdown-label">Ilo≈õƒá dni wstecz:</label>
                            <select id="daysSelect" class="days-dropdown">
                                <option value="">-- Wybierz zakres --</option>
                                <option value="1">1 dzie≈Ñ</option>
                                <option value="2">2 dni</option>
                                <option value="3">3 dni</option>
                                <option value="4">4 dni</option>
                                <option value="5">5 dni</option>
                                <option value="6">6 dni</option>
                                <option value="7">7 dni</option>
                                <option value="14">14 dni</option>
                            </select>
                        </div>

                        <div class="date-preview" id="datePreview" style="display: none;">
                            <p class="date-preview-text">
                                Zostanƒô pobrane zam√≥wienia od <strong id="dateFromPreview"></strong> 
                                do <strong id="dateToPreview"></strong>
                            </p>
                        </div>
                    </div>
                </div>

                <div class="sync-modal-footer">
                    <button id="syncDaysCancel" class="btn btn-secondary">Anuluj</button>
                    <button id="syncDaysConfirm" class="btn btn-primary" disabled>Pobierz zam√≥wienia</button>
                </div>
            </div>
        </div>
    </div>

    <!-- KROK 2: Modal z listƒÖ zam√≥wie≈Ñ do wyboru -->
    <div id="syncOrdersModal" class="sync-modal" style="display: none;">
        <div class="sync-modal-overlay">
            <div class="sync-modal-content sync-modal-large">
                <div class="sync-modal-header">
                    <h3>Wybierz zam√≥wienia do zapisania</h3>
                    <button class="sync-modal-close" id="syncOrdersModalClose">&times;</button>
                </div>

                <div class="sync-modal-body">
                    <!-- Loading state -->
                    <div id="ordersLoadingState" class="orders-loading" style="display: none;">
                        <div class="loading-spinner"></div>
                        <p>Pobieranie zam√≥wie≈Ñ z Baselinker...</p>
                    </div>

                    <!-- Orders list container -->
                    <div id="ordersListContainer" class="orders-list-container" style="display: none;">
                        <!-- Selection controls -->
                        <div class="orders-selection-controls">
                            <div class="selection-info">
                                <span id="ordersCount">0</span> zam√≥wie≈Ñ znalezionych
                            </div>
                            <div class="selection-actions">
                                <button id="selectAllOrders" class="btn btn-sm btn-secondary">Zaznacz wszystkie</button>
                                <button id="deselectAllOrders" class="btn btn-sm btn-secondary">Odznacz wszystkie</button>
                            </div>
                        </div>

                        <!-- Orders list -->
                        <div id="ordersList" class="orders-list">
                            <!-- Zam√≥wienia bƒôdƒÖ wstawiane tutaj dynamicznie -->
                        </div>
                    </div>

                    <!-- Empty state -->
                    <div id="ordersEmptyState" class="orders-empty" style="display: none;">
                        <div class="empty-icon">üìã</div>
                        <h4>Brak nowych zam√≥wie≈Ñ</h4>
                        <p>Nie znaleziono nowych zam√≥wie≈Ñ w wybranym zakresie dat.</p>
                    </div>

                    <!-- Error state -->
                    <div id="ordersErrorState" class="orders-error" style="display: none;">
                        <div class="error-icon">‚ö†Ô∏è</div>
                        <h4>B≈ÇƒÖd pobierania zam√≥wie≈Ñ</h4>
                        <p id="errorMessage">WystƒÖpi≈Ç b≈ÇƒÖd podczas pobierania zam√≥wie≈Ñ z Baselinker.</p>
                    </div>
                </div>

                <div class="sync-modal-footer">
                    <button id="ordersBack" class="btn btn-secondary">Wstecz</button>
                    <button id="ordersCancel" class="btn btn-secondary">Anuluj</button>
                    <button id="ordersSave" class="btn btn-primary" disabled>Zapisz rekordy (0)</button>
                </div>
            </div>
        </div>
    </div>

    <!-- KROK 3: Modal uzupe≈Çniania wymiar√≥w -->
    <div id="dimensionsModal" class="sync-modal" style="display: none;">
        <div class="sync-modal-overlay">
            <div class="sync-modal-content sync-modal-extra-large">
                <div class="sync-modal-header">
                    <h3>Uzupe≈Çnij brakujƒÖce wymiary</h3>
                    <button class="sync-modal-close" id="dimensionsModalClose">&times;</button>
                </div>

                <div class="sync-modal-body">
                    <div class="dimensions-info">
                        <p class="dimensions-description">
                            Niekt√≥re produkty w wybranych zam√≥wieniach nie majƒÖ kompletnych wymiar√≥w. 
                            Uzupe≈Çnij brakujƒÖce dane aby m√≥c obliczyƒá objƒôto≈õƒá (m¬≥):
                        </p>
                    </div>

                    <div id="dimensionsList" class="dimensions-list">
                        <!-- Formularz wymiar√≥w bƒôdzie wstawiony tutaj dynamicznie -->
                    </div>
                </div>

                <div class="sync-modal-footer">
                    <button id="dimensionsBack" class="btn btn-secondary">Wr√≥ƒá</button>
                    <button id="dimensionsSkip" class="btn btn-warning">Pomi≈Ñ i zapisz</button>
                    <button id="dimensionsSave" class="btn btn-primary">Uzupe≈Çnij i zapisz</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Global loading overlay -->
    <div id="syncLoadingOverlay" class="sync-loading-overlay" style="display: none;">
        <div class="sync-loading-content">
            <div class="spinner-large"></div>
            <div class="sync-loading-title" id="syncLoadingTitle">Pobieranie danych...</div>
            <div class="sync-loading-text" id="syncLoadingText">Proszƒô czekaƒá...</div>
        </div>
    </div>

    <!-- Template dla pojedynczego zam√≥wienia -->
    <template id="orderTemplate">
        <div class="order-item" data-order-id="">
            <!-- Badge dla zam√≥wie≈Ñ ju≈º istniejƒÖcych w bazie -->
            <div class="exists-badge" style="display: none; position: absolute; top: 5px; right: 5px; background: #28a745; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; z-index: 10;">
                ‚úì W bazie
            </div>

            <!-- Badge dla problem√≥w z wymiarami -->
            <div class="dimensions-issue-badge" style="display: none; position: absolute; top: 5px; right: 80px; background: #dc3545; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; z-index: 10;">
                ‚ö†Ô∏è Problemy z wymiarami
            </div>

            <!-- NOWY: Badge dla typu ceny -->
            <div class="price-type-badge" style="display: none; position: absolute; top: 30px; right: 5px; padding: 2px 6px; border-radius: 10px; font-size: 10px; z-index: 10;">
                <span class="price-type-icon">‚ÑπÔ∏è</span>
                <span class="price-type-text"></span>
            </div>

            <!-- Reszta template pozostaje bez zmian -->
            <div class="order-checkbox">
                <input type="checkbox" class="order-select" data-order-id="">
            </div>

            <div class="order-content">
                <div class="order-header">
                    <div class="order-title">
                        <strong>Zam√≥wienie #<span class="order-number"></span></strong>
                        <span class="order-status-badge"></span>
                    </div>
                    <div class="order-actions">
                        <a href="#" class="baselinker-link">üîó Baselinker</a>
                        <span class="order-date"></span>
                    </div>
                </div>

                <div class="order-info">
                    <div class="customer-info">
                        <strong>Klient:</strong> <span class="customer-name"></span>
                    </div>
                    <div class="delivery-info-container">
                        <strong>Dostawa:</strong> <span class="delivery-info"></span>
                    </div>
                </div>

                <!-- NOWA SEKCJA: Lista produkt√≥w -->
                <div class="products-section" style="border: 1px solid #e9ecef; border-radius: 4px; background: #f8f9fa; margin-bottom: 8px;">
                    <div class="products-header" style="display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; cursor: pointer;">
                        <span class="products-count-text" style="font-size: 12px; color: #6c757d; font-weight: 500;"></span>
                        <button class="products-toggle" type="button" style="background: none; border: none; color: #007bff; font-size: 11px; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                            <span class="toggle-icon" style="transition: transform 0.2s ease;">‚ñº</span>
                            <span class="toggle-text">Poka≈º produkty</span>
                        </button>
                    </div>
                    <div class="products-list" style="display: none; border-top: 1px solid #e9ecef; background: white; max-height: 200px; overflow-y: auto;">
                        <!-- Produkty bƒôdƒÖ dodane dynamicznie tutaj -->
                    </div>
                </div>

                <!-- Szczeg√≥≈Çy finansowe -->
                <div class="order-summary" style="display: flex; justify-content: flex-end; padding-top: 8px; border-top: 1px solid #e9ecef;">
                    <div class="financial-details" style="text-align: right; font-size: 12px;">
                        <div class="amount-row" style="display: flex; justify-content: space-between; min-width: 140px; margin-bottom: 2px;">
                            <span class="amount-label" style="color: #6c757d; margin-right: 8px;">Produkty:</span>
                            <span class="products-amount"></span>
                        </div>
                        <div class="amount-row" style="display: flex; justify-content: space-between; min-width: 140px; margin-bottom: 2px;">
                            <span class="amount-label" style="color: #6c757d; margin-right: 8px;">Dostawa:</span>
                            <span class="delivery-amount"></span>
                        </div>
                        <div class="amount-row total-row" style="display: flex; justify-content: space-between; min-width: 140px; border-top: 1px solid #e9ecef; padding-top: 2px; margin-top: 2px;">
                            <span class="amount-label" style="color: #2c3e50; font-weight: 600; margin-right: 8px;">Razem:</span>
                            <strong class="total-amount" style="color: #28a745; font-weight: 600;"></strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- Template dla pojedynczego zam√≥wienia z problemami wymiar√≥w -->
    <template id="dimensionOrderTemplate">
        <div class="dimension-order-item">
            <div class="dimension-order-header">
                <h4>Zam√≥wienie #<span class="order-number"></span></h4>
                <div class="order-info">
                    <span class="customer-name"></span> ‚Ä¢ <span class="order-date"></span>
                </div>
            </div>
            
            <div class="dimension-products-list">
                <!-- Produkty bƒôdƒÖ dodane tutaj -->
            </div>
        </div>
    </template>

    <!-- Template dla pojedynczego produktu z brakujƒÖcymi wymiarami -->
    <template id="dimensionProductTemplate">
        <div class="dimension-product-item">
            <div class="dimension-product-header">
                <div class="product-name"></div>
                <div class="product-quantity">Ilo≈õƒá: <span></span></div>
            </div>
            
            <div class="dimension-inputs-grid">
                <div class="dimension-input-group">
                    <label>D≈Çugo≈õƒá (cm)</label>
                    <input type="number" 
                        class="dimension-input" 
                        data-dimension="length_cm"
                        step="0.1" 
                        min="0"
                        placeholder="np. 120">
                </div>
                
                <div class="dimension-input-group">
                    <label>Szeroko≈õƒá (cm)</label>
                    <input type="number" 
                        class="dimension-input" 
                        data-dimension="width_cm"
                        step="0.1" 
                        min="0"
                        placeholder="np. 60">
                </div>
                
                <div class="dimension-input-group">
                    <label>Grubo≈õƒá (mm)</label>
                    <input type="number" 
                        class="dimension-input" 
                        data-dimension="thickness_mm"
                        step="0.1" 
                        min="0"
                        placeholder="np. 18">
                </div>
                
                <div class="dimension-calculated">
                    <label for="volumeInput">Objƒôto≈õƒá m¬≥</label>
                    <input type="number"
                           class="calculated-volume"
                           data-dimension="volume_m3"
                           step="0.0001"
                           min="0"
                           placeholder="np. 0.1234">
                </div>
            </div>
            
            <div class="missing-dimensions-info">
                Brakuje: <span class="missing-list"></span>
            </div>
        </div>
    </template>

    <!-- Loading overlay dla ca≈Çego procesu -->
    <div id="syncGlobalLoading" class="sync-global-loading" style="display: none;">
        <div class="sync-loading-content">
            <div class="loading-spinner-large"></div>
            <h4 id="syncGlobalLoadingTitle">Zapisywanie zam√≥wie≈Ñ...</h4>
            <p id="syncGlobalLoadingText">Proszƒô czekaƒá, trwa zapisywanie zam√≥wie≈Ñ do bazy danych.</p>
        </div>
    </div>

    <!-- Template dla pojedynczego zam√≥wienia -->
    <template id="orderItemTemplate">
        <div class="order-item" data-order-id="">
            <div class="order-checkbox">
                <input type="checkbox" class="order-select" data-order-id="">
            </div>
            
            <div class="order-content">
                <div class="order-header">
                    <div class="order-id">
                        <strong>Zam√≥wienie #<span class="order-number"></span></strong>
                        <span class="order-status-badge"></span>
                    </div>
                    <div class="order-actions">
                        <button class="baselinker-btn" type="button" title="Otw√≥rz w Baselinker">
                            <i class="fas fa-external-link-alt"></i>
                        </button>
                        <span class="order-date-text"></span>
                    </div>
                </div>
                
                <div class="order-details">
                    <div class="order-customer">
                        <span class="customer-icon">üë§</span>
                        <span class="customer-name"></span>
                    </div>
                    
                    <div class="order-products">
                        <span class="products-icon">üì¶</span>
                        <div class="products-list"></div>
                    </div>
                    
                    <div class="order-amounts">
                        <div class="amount-item">
                            <span class="amount-label">Produkty:</span>
                            <span class="amount-value products-amount"></span>
                        </div>
                        <div class="amount-item">
                            <span class="amount-label">Dostawa:</span>
                            <span class="amount-value delivery-amount"></span>
                        </div>
                        <div class="amount-item total">
                            <span class="amount-label">Razem:</span>
                            <span class="amount-value total-amount"></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="order-status">
                <div class="exists-badge" style="display: none;">
                    <span class="exists-icon">‚úì</span>
                    <span class="exists-text">Ju≈º w bazie</span>
                </div>
            </div>
        </div>
    </template>

    

    <!-- Modal dodawania/edycji rƒôcznego wiersza -->
    <div id="manualRowModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3 id="manualRowModalTitle">Dodaj wiersz</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Zak≈Çadki -->
                <div class="modal-tabs">
                    <div class="tab-buttons">
                        <button type="button" class="tab-button active" data-tab="client">
                            <i class="fas fa-user"></i>
                            Klient
                        </button>
                        <button type="button" class="tab-button" data-tab="products">
                            <i class="fas fa-box"></i>
                            Produkty
                            <span class="product-count" id="productCountBadge">1</span>
                        </button>
                        <button type="button" class="tab-button" data-tab="order">
                            <i class="fas fa-shopping-cart"></i>
                            Zam√≥wienie
                        </button>
                    </div>
                </div>

                <form id="manualRowForm">
                    <input type="hidden" id="recordId" name="record_id">

                    <!-- Tab Klient -->
                    <div class="tab-content active" id="clientTab">
                        <div class="form-section">
                            <h4>Dane klienta</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="customerName">Imiƒô i nazwisko: <span class="required">*</span></label>
                                    <input type="text" id="customerName" name="customer_name" required>
                                </div>
                                <div class="form-group">
                                    <label for="phone">Telefon:</label>
                                    <input type="tel" id="phone" name="phone">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="caretaker">Opiekun (kto z≈Ço≈ºy≈Ç zam√≥wienie):</label>
                                    <select id="caretaker" name="caretaker">
                                        <option value="">-- Wybierz opiekuna --</option>
                                        <option value="Sylwester Rƒôbi≈õ">Sylwester Rƒôbi≈õ</option>
                                        <option value="Barbara Kowal">Barbara Kowal</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h4>Adres dostawy</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="deliveryAddress">Ulica i numer:</label>
                                    <input type="text" id="deliveryAddress" name="delivery_address">
                                </div>
                                <div class="form-group">
                                    <label for="deliveryPostcode">Kod pocztowy:</label>
                                    <input type="text" id="deliveryPostcode" name="delivery_postcode" pattern="[0-9]{2}-[0-9]{3}" placeholder="00-000">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="deliveryCity">Miejscowo≈õƒá:</label>
                                    <input type="text" id="deliveryCity" name="delivery_city">
                                </div>
                                <div class="form-group">
                                    <label for="deliveryState">Wojew√≥dztwo:</label>
                                    <select id="deliveryState" name="delivery_state">
                                        <option value="">-- Wybierz wojew√≥dztwo --</option>
                                        <option value="dolno≈õlƒÖskie">Dolno≈õlƒÖskie</option>
                                        <option value="kujawsko-pomorskie">Kujawsko-pomorskie</option>
                                        <option value="lubelskie">Lubelskie</option>
                                        <option value="lubuskie">Lubuskie</option>
                                        <option value="≈Ç√≥dzkie">≈Å√≥dzkie</option>
                                        <option value="ma≈Çopolskie">Ma≈Çopolskie</option>
                                        <option value="mazowieckie">Mazowieckie</option>
                                        <option value="opolskie">Opolskie</option>
                                        <option value="podkarpackie">Podkarpackie</option>
                                        <option value="podlaskie">Podlaskie</option>
                                        <option value="pomorskie">Pomorskie</option>
                                        <option value="≈õlƒÖskie">≈ölƒÖskie</option>
                                        <option value="≈õwiƒôtokrzyskie">≈öwiƒôtokrzyskie</option>
                                        <option value="warmi≈Ñsko-mazurskie">Warmi≈Ñsko-mazurskie</option>
                                        <option value="wielkopolskie">Wielkopolskie</option>
                                        <option value="zachodniopomorskie">Zachodniopomorskie</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab Produkty -->
                    <div class="tab-content" id="productsTab">
                        <div class="form-section">
                            <div class="products-header">
                                <h4>Lista produkt√≥w</h4>
                                <button type="button" class="btn btn-success btn-sm" id="addProductBtn">
                                    <i class="fas fa-plus"></i>
                                    Dodaj produkt
                                </button>
                            </div>

                            <!-- Przyciski prze≈ÇƒÖczania miƒôdzy produktami -->
                            <div class="products-tabs" id="productsTabs">
                                <!-- Zak≈Çadki produkt√≥w bƒôdƒÖ dodawane dynamicznie -->
                            </div>

                            <div id="productsList">
                                <!-- Produkty bƒôdƒÖ dodawane dynamicznie -->
                            </div>

                            <!-- Podsumowanie produkt√≥w -->
                            <div class="products-summary">
                                <div class="summary-row">
                                    <span>≈ÅƒÖczna objƒôto≈õƒá:</span>
                                    <strong id="totalVolume">0.00 m¬≥</strong>
                                </div>
                                <div class="summary-row">
                                    <span>≈ÅƒÖczna warto≈õƒá netto:</span>
                                    <strong id="totalValueNet">0.00 z≈Ç</strong>
                                </div>
                                <div class="summary-row">
                                    <span>≈ÅƒÖczna warto≈õƒá brutto:</span>
                                    <strong id="totalValueGross">0.00 z≈Ç</strong>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab Zam√≥wienie -->
                    <div class="tab-content" id="orderTab">
                        <div class="form-section">
                            <h4>Informacje o zam√≥wieniu</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="dateCreated">Data zam√≥wienia: <span class="required">*</span></label>
                                    <input type="date" id="dateCreated" name="date_created" required>
                                </div>
                                <div class="form-group">
                                    <label for="baselinkerOrderId">Numer zam√≥wienia Baselinker:</label>
                                    <input type="number" id="baselinkerOrderId" name="baselinker_order_id" min="1">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="internalOrderNumber">Numer wewnƒôtrzny:</label>
                                    <input type="text" id="internalOrderNumber" name="internal_order_number">
                                </div>
                                <div class="form-group">
                                    <label for="orderSource">≈πr√≥d≈Ço zam√≥wienia:</label>
                                    <select id="orderSource" name="order_source">
                                        <option value="">-- Wybierz ≈∫r√≥d≈Ço --</option>
                                        <option value="sklep">Sklep</option>
                                        <option value="allegro">Allegro</option>
                                        <option value="olx">OLX</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h4>Dostawa i p≈Çatno≈õƒá</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="deliveryMethod">Metoda dostawy:</label>
                                    <select id="deliveryMethod" name="delivery_method">
                                        <option value="">-- Wybierz metodƒô dostawy --</option>
                                        <option value="Przesy≈Çka kurierska">Przesy≈Çka kurierska</option>
                                        <option value="Odbi√≥r osobisty">Odbi√≥r osobisty</option>
                                        <option value="Transport Woodpower">Transport Woodpower</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="deliveryCost">Koszt dostawy:</label>
                                    <input type="number" step="0.01" id="deliveryCost" name="delivery_cost" value="0">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="paymentMethod">Spos√≥b p≈Çatno≈õci:</label>
                                    <input type="text" id="paymentMethod" name="payment_method" placeholder="np. got√≥wka, przelew">
                                </div>
                                <div class="form-group">
                                    <label for="paidAmountNet">Zap≈Çacono netto:</label>
                                    <input type="number" step="0.01" id="paidAmountNet" name="paid_amount_net" value="0">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="currentStatus">Status zam√≥wienia:</label>
                                    <select id="currentStatus" name="current_status">
                                        <option value="Nowe - nieop≈Çacone">Nowe - nieop≈Çacone</option>
                                        <option value="Nowe - op≈Çacone" selected>Nowe - op≈Çacone</option>
                                        <option value="W produkcji - surowe">W produkcji - surowe</option>
                                        <option value="W produkcji - olejowanie">W produkcji - olejowanie</option>
                                        <option value="W produkcji - bejtowanie">W produkcji - bejtowanie</option>
                                        <option value="W produkcji - lakierowanie">W produkcji - lakierowanie</option>
                                        <option value="Produkcja zako≈Ñczona">Produkcja zako≈Ñczona</option>
                                        <option value="Zam√≥wienie spakowane">Zam√≥wienie spakowane</option>
                                        <option value="Paczka zg≈Çoszona do wysy≈Çki">Paczka zg≈Çoszona do wysy≈Çki</option>
                                        <option value="Wys≈Çane - kurier">Wys≈Çane - kurier</option>
                                        <option value="Wys≈Çane - transport WoodPower">Wys≈Çane - transport WoodPower</option>
                                        <option value="Czeka na odbi√≥r osobisty">Czeka na odbi√≥r osobisty</option>
                                        <option value="Dostarczona - kurier">Dostarczona - kurier</option>
                                        <option value="Dostarczona - trans. WoodPower">Dostarczona - trans. WoodPower</option>
                                        <option value="Odebrane">Odebrane</option>
                                        <option value="Zam√≥wienie anulowane">Zam√≥wienie anulowane</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="manualRowCancel" class="btn btn-secondary">Anuluj</button>
                <button id="manualRowSave" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    Zapisz
                </button>
            </div>
        </div>
    </div>

    <!-- Template dla pojedynczego produktu -->
    <template id="productItemTemplate">
        <div class="product-item" data-product-index="">
            <div class="product-header">
                <h5>Produkt <span class="product-number"></span></h5>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Grupa: <span class="required">*</span></label>
                    <select class="product-field" name="group_type" required>
                        <option value="">-- Wybierz grupƒô --</option>
                        <option value="towar">Towar</option>
                        <option value="us≈Çuga">Us≈Çuga</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Rodzaj: <span class="required">*</span></label>
                    <select class="product-field" name="product_type" required>
                        <option value="">-- Wybierz rodzaj --</option>
                        <option value="klejonka">Klejonka</option>
                        <option value="deska">Deska</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Gatunek drewna:</label>
                    <select class="product-field" name="wood_species">
                        <option value="">-- Wybierz gatunek --</option>
                        <option value="DƒÖb">DƒÖb</option>
                        <option value="Jesion">Jesion</option>
                        <option value="Buk">Buk</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Technologia:</label>
                    <select class="product-field" name="technology">
                        <option value="">-- Wybierz technologiƒô --</option>
                        <option value="Lity">Lity</option>
                        <option value="Mikrowczep">Mikrowczep</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Klasa:</label>
                    <select class="product-field" name="wood_class">
                        <option value="">-- Wybierz klasƒô --</option>
                        <option value="A/B">A/B</option>
                        <option value="B/B">B/B</option>
                        <option value="Rustic">Rustic</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Stan wyko≈Ñczenia:</label>
                    <select class="product-field" name="finish_state">
                        <option value="surowy">Surowy</option>
                        <option value="lakierowany">Lakierowany</option>
                        <option value="olejowany">Olejowany</option>
                        <option value="inne">Inne</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>D≈Çugo≈õƒá (cm): <span class="required">*</span></label>
                    <input type="number" step="0.1" class="product-field dimension-field" name="length_cm" required>
                </div>
                <div class="form-group">
                    <label>Szeroko≈õƒá (cm): <span class="required">*</span></label>
                    <input type="number" step="0.1" class="product-field dimension-field" name="width_cm" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Grubo≈õƒá (cm): <span class="required">*</span></label>
                    <input type="number" step="0.1" class="product-field dimension-field" name="thickness_cm" required>
                </div>
                <div class="form-group">
                    <label>Ilo≈õƒá (szt): <span class="required">*</span></label>
                    <input type="number" min="1" class="product-field quantity-field" name="quantity" value="1" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Cena netto za sztukƒô:</label>
                    <input type="number" step="0.01" class="product-field price-field" name="price_net">
                </div>
                <div class="form-group product-calculations">
                    <div class="calc-row">
                        <span>Objƒôto≈õƒá za szt:</span>
                        <strong class="volume-per-piece">0.00 m¬≥</strong>
                    </div>
                    <div class="calc-row">
                        <span>≈ÅƒÖczna objƒôto≈õƒá:</span>
                        <strong class="total-volume">0.00 m¬≥</strong>
                    </div>
                    <div class="calc-row">
                        <span>Warto≈õƒá netto:</span>
                        <strong class="total-price-net">0.00 z≈Ç</strong>
                    </div>
                    <div class="calc-row">
                        <span>Warto≈õƒá brutto:</span>
                        <strong class="total-price-gross">0.00 z≈Ç</strong>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- Overlay do ≈Çadowania -->
    <div id="syncLoadingOverlay" class="sync-loading-overlay hidden">
        <div class="sync-loading-content">
            <div class="spinner-large"></div>
            <div class="sync-loading-text" id="syncLoadingText">Pobieranie danych...</div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script src="{{ url_for('static', filename='js/sidebar.js') }}"></script>
    <script src="{{ url_for('reports.static', filename='js/reports.js') }}"></script>
    <script src="{{ url_for('reports.static', filename='js/table_manager.js') }}"></script>
    <script src="{{ url_for('reports.static', filename='js/sync_manager.js') }}"></script>
    <script src="{{ url_for('reports.static', filename='js/postcode_auto_fill.js') }}"></script>
    <script src="{{ url_for('reports.static', filename='js/export_manager.js') }}"></script>
    <script src="{{ url_for('reports.static', filename='js/fullscreen_manager.js') }}"></script>

    <script>
    // Globalne zmienne - poprawiona wersja
    window.reportsConfig = {
        userEmail: "{{ user_email | e if user_email else '' }}",
        hasNewOrders: {{ 'true' if has_new_orders else 'false' }},
        newOrdersCount: {{ new_orders_count | int if new_orders_count else 0 }},
        totalRecords: {{ total_records | int if total_records else 0 }},
        // POPRAWKA: Przekazuj stats i comparison tylko je≈õli majƒÖ sensowne warto≈õci
        stats: {% if stats and (stats.total_m3 > 0 or stats.order_amount_net > 0) %}{{ stats | tojson }}{% else %}{}{% endif %},
        comparison: {% if comparison and comparison %}{{ comparison | tojson }}{% else %}{}{% endif %},
        default_date_from: "{{ default_date_from if default_date_from else '' }}",
        default_date_to: "{{ default_date_to if default_date_to else '' }}",
        lastSync: {% if last_sync %}"{{ last_sync.sync_date.isoformat() }}"{% else %}null{% endif %}
    };

    // Inicjalizacja po za≈Çadowaniu strony
    document.addEventListener('DOMContentLoaded', function() {
        console.log('[Reports] Inicjalizacja modu≈Çu...');
        console.log('[Reports] Config:', window.reportsConfig);

        // Inicjalizuj managery
        if (typeof ReportsManager !== 'undefined') {
            window.reportsManager = new ReportsManager();
            window.reportsManager.init();
        }

        if (typeof TableManager !== 'undefined') {
            window.tableManager = new TableManager();
            window.tableManager.init();
        }

        if (typeof SyncManager !== 'undefined') {
            window.syncManager = new SyncManager();
            window.syncManager.init();
        }

        if (typeof ExportManager !== 'undefined') {
            window.exportManager = new ExportManager();
            window.exportManager.init();
        }

        // NOWY: Inicjalizuj FullscreenManager
        if (typeof FullscreenManager !== 'undefined') {
            window.fullscreenManager = new FullscreenManager();
            window.fullscreenManager.init();
        }

        // Je≈õli brak danych w bazie, poka≈º komunikat
        if (window.reportsConfig.totalRecords === 0) {
            console.log('[Reports] Brak danych w bazie - pierwsza synchronizacja wymagana');
        }

        console.log('[Reports] Modu≈Ç zainicjalizowany');
    });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Dodaj tooltip informujƒÖcy o auto-uzupe≈Çnianiu
            const stateInput = document.getElementById('deliveryState');
            if (stateInput) {
                stateInput.setAttribute('title', 'Wojew√≥dztwo zostanie automatycznie uzupe≈Çnione na podstawie kodu pocztowego');
                stateInput.setAttribute('placeholder', 'Wpisz lub zostanie uzupe≈Çnione automatycznie');
            }

            // Dodaj event listener na kod pocztowy dla wizualnego feedbacku
            const postcodeInput = document.getElementById('deliveryPostcode');
            if (postcodeInput) {
                postcodeInput.setAttribute('title', 'Wpisz kod pocztowy aby automatycznie uzupe≈Çniƒá wojew√≥dztwo');
                postcodeInput.setAttribute('placeholder', 'np. 00-001');

                // Dodaj walidacjƒô formatu kodu pocztowego
                postcodeInput.addEventListener('input', function (e) {
                    let value = e.target.value.replace(/[^0-9]/g, '');
                    if (value.length >= 2) {
                        value = value.substring(0, 2) + '-' + value.substring(2, 5);
                    }
                    e.target.value = value;
                });
            }
        });
    </script>
</body>
</html>