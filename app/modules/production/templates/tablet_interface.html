<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ workstation.name }} - Wood Power Production</title>
    
    <!-- Style modułu production -->
    <link rel="stylesheet" href="{{ url_for('production.static', filename='css/tablet.css') }}">
    
    <!-- Font Awesome dla ikon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Meta dla tabletu -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
</head>
<body class="tablet-interface">
    <!-- Header tabletu -->
    <div class="tablet-header">
        <div class="header-left">
            <div class="logo">
                <img src="{{ url_for('static', filename='images/logo-crm-sidebar.svg') }}" alt="Wood Power">
            </div>
            <div class="workstation-info">
                <h1>{{ workstation.name }}</h1>
                <span class="workstation-number">Stanowisko {{ workstation.sequence_order }}</span>
            </div>
        </div>
        
        <div class="header-center">
            {% if current_batch %}
            <div class="current-batch">
                <div class="batch-name">{{ current_batch.name }}</div>
                <div class="batch-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: {{ current_batch.get_completion_percentage() }}%"></div>
                    </div>
                    <span>{{ current_batch.completed_task_count }}/{{ current_batch.task_count }}</span>
                </div>
            </div>
            {% endif %}
        </div>
        
        <div class="header-right">
            <div class="datetime">
                <div class="time" id="currentTime">{{ moment().format('HH:mm:ss') }}</div>
                <div class="date">{{ moment().format('DD.MM.YYYY') }}</div>
            </div>
            <button class="refresh-btn" onclick="refreshTasks()">
                <i class="fas fa-sync"></i>
            </button>
        </div>
    </div>

    <!-- Status bar -->
    <div class="status-bar">
        <div class="status-item">
            <i class="fas fa-tasks"></i>
            <span id="tasksInQueue">{{ tasks|length }} zadań w kolejce</span>
        </div>
        <div class="status-item">
            <i class="fas fa-clock"></i>
            <span id="shiftTime">Zmiana: 06:00 - 14:00</span>
        </div>
        <div class="status-item connection-status" id="connectionStatus">
            <i class="fas fa-wifi"></i>
            <span>Połączono</span>
        </div>
    </div>

    <!-- Główna zawartość -->
    <div class="tablet-content">
        {% if tasks %}
            <!-- Aktualne zadanie (pierwsze w kolejce) -->
            {% set current_task = tasks[0] %}
            <div class="current-task-section">
                <div class="section-header">
                    <h2>
                        <i class="fas fa-play-circle"></i>
                        Aktualne zadanie
                    </h2>
                    <div class="priority-badge priority-current">
                        #{{ loop.index }}
                    </div>
                </div>

                <div class="current-task-card" data-task-id="{{ current_task.id }}">
                    <div class="task-main-info">
                        <div class="task-product">
                            <h3>{{ current_task.product_name }}</h3>
                            <div class="product-specs">
                                <span class="spec-item">
                                    <i class="fas fa-ruler-combined"></i>
                                    {{ current_task.dimensions }}
                                </span>
                                <span class="spec-item">
                                    <i class="fas fa-tree"></i>
                                    {{ current_task.wood_species|title }} {{ current_task.technology }}
                                </span>
                                <span class="spec-item">
                                    <i class="fas fa-hashtag"></i>
                                    {{ current_task.quantity }} szt.
                                </span>
                                {% if current_task.wood_class %}
                                <span class="spec-item">
                                    <i class="fas fa-star"></i>
                                    Klasa {{ current_task.wood_class }}
                                </span>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Status zadania -->
                        {% set current_progress = None %}
                        {% for progress in current_task.progress_records %}
                            {% if progress.workstation_id == workstation.id %}
                                {% set current_progress = progress %}
                                {% break %}
                            {% endif %}
                        {% endfor %}

                        <div class="task-status-display">
                            {% if current_progress %}
                                {% if current_progress.status == 'pending' %}
                                    <div class="status-indicator status-waiting">
                                        <i class="fas fa-clock"></i>
                                        <span>Oczekuje na rozpoczęcie</span>
                                    </div>
                                {% elif current_progress.status == 'in_progress' %}
                                    <div class="status-indicator status-active">
                                        <i class="fas fa-play"></i>
                                        <span>W trakcie realizacji</span>
                                        {% if current_progress.started_at %}
                                        <small>od {{ current_progress.started_at.strftime('%H:%M') }}</small>
                                        {% endif %}
                                    </div>
                                {% elif current_progress.status == 'completed' %}
                                    <div class="status-indicator status-done">
                                        <i class="fas fa-check"></i>
                                        <span>Ukończone</span>
                                    </div>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>

                    <!-- Wykończenie (jeśli wymagane) -->
                    {% if current_task.needs_coating %}
                    <div class="coating-requirements">
                        <div class="coating-header">
                            <i class="fas fa-paint-brush"></i>
                            <span>Wymagane wykończenie</span>
                        </div>
                        <div class="coating-details">
                            <span class="coating-type">{{ current_task.coating_type|title }}</span>
                            {% if current_task.coating_color %}
                                <span class="coating-color">{{ current_task.coating_color }}</span>
                            {% endif %}
                            {% if current_task.coating_gloss %}
                                <span class="coating-gloss">{{ current_task.coating_gloss }}</span>
                            {% endif %}
                        </div>
                        {% if current_task.coating_notes %}
                        <div class="coating-notes">
                            <i class="fas fa-info-circle"></i>
                            {{ current_task.coating_notes }}
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- Duże przyciski akcji -->
                    <div class="tablet-actions">
                        {% if current_progress and current_progress.status == 'pending' %}
                            <button class="tablet-btn tablet-btn-start" onclick="startTask({{ current_task.id }})">
                                <i class="fas fa-play"></i>
                                <span>ROZPOCZNIJ</span>
                            </button>
                        {% elif current_progress and current_progress.status == 'in_progress' %}
                            <button class="tablet-btn tablet-btn-complete" onclick="completeTask({{ current_task.id }})">
                                <i class="fas fa-check"></i>
                                <span>ZAKOŃCZ</span>
                            </button>
                            <button class="tablet-btn tablet-btn-pause" onclick="pauseTask({{ current_task.id }})">
                                <i class="fas fa-pause"></i>
                                <span>PAUZA</span>
                            </button>
                        {% else %}
                            <button class="tablet-btn tablet-btn-disabled" disabled>
                                <i class="fas fa-hourglass-half"></i>
                                <span>CZEKA NA POPRZEDNI ETAP</span>
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Kolejne zadania -->
            {% if tasks|length > 1 %}
            <div class="next-tasks-section">
                <div class="section-header">
                    <h2>
                        <i class="fas fa-list"></i>
                        Kolejne zadania ({{ tasks|length - 1 }})
                    </h2>
                </div>

                <div class="next-tasks-list">
                    {% for task in tasks[1:6] %}  <!-- Pokaż maksymalnie 5 następnych -->
                    <div class="next-task-item">
                        <div class="task-priority">
                            <span class="priority-number">#{{ loop.index + 1 }}</span>
                        </div>
                        <div class="task-info">
                            <div class="task-name">{{ task.product_name[:40] }}{% if task.product_name|length > 40 %}...{% endif %}</div>
                            <div class="task-specs">
                                {{ task.dimensions }} | {{ task.wood_species }} {{ task.technology }}
                                {% if task.needs_coating %} | {{ task.coating_type }}{% endif %}
                            </div>
                        </div>
                        <div class="task-eta">
                            {% if task.estimated_completion_date %}
                                {% set days_left = (task.estimated_completion_date - moment().date()).days %}
                                {% if days_left <= 0 %}
                                    <span class="eta-urgent">Pilne!</span>
                                {% elif days_left == 1 %}
                                    <span class="eta-today">Jutro</span>
                                {% else %}
                                    <span class="eta-normal">{{ days_left }}d</span>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                    
                    {% if tasks|length > 6 %}
                    <div class="more-tasks">
                        <i class="fas fa-ellipsis-h"></i>
                        <span>i {{ tasks|length - 6 }} więcej...</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        {% else %}
            <!-- Brak zadań -->
            <div class="no-tasks-state">
                <div class="no-tasks-content">
                    <i class="fas fa-check-circle"></i>
                    <h2>Wszystkie zadania ukończone!</h2>
                    <p>Stanowisko jest gotowe na nowe zlecenia.</p>
                    <button class="tablet-btn tablet-btn-secondary" onclick="refreshTasks()">
                        <i class="fas fa-sync"></i>
                        <span>SPRAWDŹ NOWE ZADANIA</span>
                    </button>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- Modal potwierdzenia zakończenia -->
    <div id="completeModal" class="tablet-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Potwierdź zakończenie zadania</h3>
            </div>
            <div class="modal-body">
                <p>Czy na pewno chcesz zakończyć bieżące zadanie?</p>
                <div class="form-group">
                    <label>Uwagi (opcjonalne):</label>
                    <textarea id="completionNotes" rows="3" placeholder="Dodaj uwagi o wykonanej pracy..."></textarea>
                </div>
            </div>
            <div class="modal-actions">
                <button class="tablet-btn tablet-btn-secondary" onclick="closeCompleteModal()">
                    <span>ANULUJ</span>
                </button>
                <button class="tablet-btn tablet-btn-complete" onclick="confirmComplete()">
                    <i class="fas fa-check"></i>
                    <span>ZAKOŃCZ</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal pauzy -->
    <div id="pauseModal" class="tablet-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Wstrzymaj zadanie</h3>
            </div>
            <div class="modal-body">
                <p>Wybierz powód wstrzymania:</p>
                <div class="pause-reasons">
                    <button class="reason-btn" data-reason="Brak materiału">
                        <i class="fas fa-box"></i>
                        <span>Brak materiału</span>
                    </button>
                    <button class="reason-btn" data-reason="Awaria maszyny">
                        <i class="fas fa-tools"></i>
                        <span>Awaria maszyny</span>
                    </button>
                    <button class="reason-btn" data-reason="Przerwa">
                        <i class="fas fa-coffee"></i>
                        <span>Przerwa</span>
                    </button>
                    <button class="reason-btn" data-reason="Problem jakościowy">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Problem jakościowy</span>
                    </button>
                    <button class="reason-btn" data-reason="Inne">
                        <i class="fas fa-question"></i>
                        <span>Inne</span>
                    </button>
                </div>
                <div class="form-group">
                    <label>Dodatkowe uwagi:</label>
                    <textarea id="pauseNotes" rows="2" placeholder="Opisz szczegóły..."></textarea>
                </div>
            </div>
            <div class="modal-actions">
                <button class="tablet-btn tablet-btn-secondary" onclick="closePauseModal()">
                    <span>ANULUJ</span>
                </button>
                <button class="tablet-btn tablet-btn-pause" onclick="confirmPause()" disabled id="confirmPauseBtn">
                    <i class="fas fa-pause"></i>
                    <span>WSTRZYMAJ</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Loading overlay -->
    <div id="loadingOverlay" class="tablet-loading" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner">
                <i class="fas fa-cog fa-spin"></i>
            </div>
            <p>Przetwarzanie...</p>
        </div>
    </div>

    <!-- Toast notifications -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Scripts -->
    <script src="{{ url_for('production.static', filename='js/tablet_interface.js') }}"></script>
    
    <script>
        // Konfiguracja tabletu
        const TABLET_CONFIG = {
            workstationId: {{ workstation.id }},
            tabletId: '{{ tablet_identifier }}',
            refreshInterval: 30000, // 30 sekund
            apiEndpoint: '/production/api'
        };

        let currentTaskId = null;
        let selectedPauseReason = null;

        // Inicjalizacja
        document.addEventListener('DOMContentLoaded', function() {
            TabletInterface.init(TABLET_CONFIG);
            updateCurrentTime();
            
            // Auto-refresh
            setInterval(() => {
                updateCurrentTime();
                refreshTasks();
            }, TABLET_CONFIG.refreshInterval);

            // Setup pause reason buttons
            document.querySelectorAll('.reason-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    selectPauseReason(this.dataset.reason);
                });
            });
        });

        function updateCurrentTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('pl-PL', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            const timeElement = document.getElementById('currentTime');
            if (timeElement) {
                timeElement.textContent = timeStr;
            }
        }

        function refreshTasks() {
            TabletInterface.checkConnection();
            
            fetch(`${TABLET_CONFIG.apiEndpoint}/workstation/${TABLET_CONFIG.workstationId}/tasks`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateTasksDisplay(data.tasks);
                    }
                })
                .catch(error => {
                    console.error('Błąd odświeżania:', error);
                    TabletInterface.showConnectionError();
                });
        }

        function updateTasksDisplay(tasks) {
            document.getElementById('tasksInQueue').textContent = `${tasks.length} zadań w kolejce`;
            // TODO: Dynamiczna aktualizacja bez przeładowania
        }

        function startTask(taskId) {
            showLoading('Rozpoczynam zadanie...');
            
            TabletInterface.executeAction('start', taskId, {
                tablet_identifier: TABLET_CONFIG.tabletId
            })
            .then(result => {
                hideLoading();
                if (result.success) {
                    showToast('Zadanie rozpoczęte!', 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast(result.error, 'error');
                }
            })
            .catch(error => {
                hideLoading();
                showToast('Błąd rozpoczęcia zadania', 'error');
            });
        }

        function completeTask(taskId) {
            currentTaskId = taskId;
            document.getElementById('completeModal').style.display = 'flex';
        }

        function confirmComplete() {
            const notes = document.getElementById('completionNotes').value;
            showLoading('Kończę zadanie...');
            
            TabletInterface.executeAction('complete', currentTaskId, {
                tablet_identifier: TABLET_CONFIG.tabletId,
                notes: notes
            })
            .then(result => {
                hideLoading();
                closeCompleteModal();
                if (result.success) {
                    showToast(`Zadanie ukończone! Następny etap: ${result.next_station}`, 'success', 3000);
                    setTimeout(() => location.reload(), 2000);
                } else {
                    showToast(result.error, 'error');
                }
            })
            .catch(error => {
                hideLoading();
                closeCompleteModal();
                showToast('Błąd kończenia zadania', 'error');
            });
        }

        function pauseTask(taskId) {
            currentTaskId = taskId;
            selectedPauseReason = null;
            document.getElementById('confirmPauseBtn').disabled = true;
            document.getElementById('pauseModal').style.display = 'flex';
        }

        function selectPauseReason(reason) {
            // Usuń poprzednie zaznaczenie
            document.querySelectorAll('.reason-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Zaznacz wybrany powód
            document.querySelector(`[data-reason="${reason}"]`).classList.add('selected');
            selectedPauseReason = reason;
            
            // Włącz przycisk potwierdzenia
            document.getElementById('confirmPauseBtn').disabled = false;
        }

        function confirmPause() {
            if (!selectedPauseReason) return;
            
            const notes = document.getElementById('pauseNotes').value;
            const fullReason = notes ? `${selectedPauseReason}: ${notes}` : selectedPauseReason;
            
            showLoading('Wstrzymuję zadanie...');
            
            TabletInterface.executeAction('pause', currentTaskId, {
                tablet_identifier: TABLET_CONFIG.tabletId,
                reason: fullReason
            })
            .then(result => {
                hideLoading();
                closePauseModal();
                if (result.success) {
                    showToast('Zadanie wstrzymane', 'info');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast(result.error, 'error');
                }
            })
            .catch(error => {
                hideLoading();
                closePauseModal();
                showToast('Błąd wstrzymania zadania', 'error');
            });
        }

        function closeCompleteModal() {
            document.getElementById('completeModal').style.display = 'none';
            document.getElementById('completionNotes').value = '';
            currentTaskId = null;
        }

        function closePauseModal() {
            document.getElementById('pauseModal').style.display = 'none';
            document.getElementById('pauseNotes').value = '';
            document.querySelectorAll('.reason-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            selectedPauseReason = null;
            currentTaskId = null;
        }

        function showLoading(message = 'Przetwarzanie...') {
            const overlay = document.getElementById('loadingOverlay');
            const messageEl = overlay.querySelector('p');
            messageEl.textContent = message;
            overlay.style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showToast(message, type = 'info', duration = 2000) {
            TabletInterface.showToast(message, type, duration);
        }

        // Zapobieganie wygaśnięciu ekranu
        let wakeLock = null;
        if ('wakeLock' in navigator) {
            navigator.wakeLock.request('screen').then(function(lock) {
                wakeLock = lock;
            }).catch(function(err) {
                console.log('Wake lock failed:', err);
            });
        }
    </script>
</body>
</html>