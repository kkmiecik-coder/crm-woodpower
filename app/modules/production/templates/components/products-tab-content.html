<!-- products-tab-content.html -->
<!-- ============================================================================
     SEKCJA FILTRÓW - UPROSZCZONA WERSJA (BEZ PRZYCISKU ZAAWANSOWANE)
     ============================================================================ -->
<div class="products-filters">
    <div class="row g-3">
        <!-- Status produktu -->
        <div class="col-md-3">
            <label for="status-filter" class="form-label">Status produktu</label>
            <select id="status-filter" class="form-select">
                <option value="all">Wszystkie statusy</option>
                <option value="czeka_na_wyciecie">Czeka na wycięcie</option>
                <option value="czeka_na_skladanie">Czeka na składanie</option>
                <option value="czeka_na_pakowanie">Czeka na pakowanie</option>
                <option value="spakowane">Spakowane</option>
                <option value="wstrzymane">Wstrzymane</option>
                <option value="anulowane">Anulowane</option>
            </select>
        </div>

        <!-- Wyszukiwanie - JEDEN INPUT -->
        <div class="col-md-4">
            <label for="search-input" class="form-label">Wyszukaj produkt</label>
            <div class="input-group">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text"
                       id="search-input"
                       class="form-control"
                       placeholder="ID zamówienia, nazwa produktu, klient..."
                       value="">
                <button class="btn btn-outline-secondary" type="button" id="clear-search-btn" title="Wyczyść wyszukiwanie">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <!-- Gatunek drewna -->
        <div class="col-md-2">
            <label for="wood-species-filter" class="form-label">Gatunek drewna</label>
            <select id="wood-species-filter" class="form-select">
                <option value="">Wszystkie</option>
                <!-- Opcje będą ładowane dynamicznie -->
            </select>
        </div>

        <!-- Produktów na stronę -->
        <div class="col-md-2">
            <label for="per-page-select" class="form-label">Na stronę</label>
            <select id="per-page-select" class="form-select">
                <option value="25">25</option>
                <option value="50" selected>50</option>
                <option value="100">100</option>
                <option value="200">200</option>
            </select>
        </div>

        <!-- Przycisk odświeżania -->
        <div class="col-md-1">
            <label class="form-label">&nbsp;</label>
            <button class="btn btn-outline-primary w-100" onclick="refreshProductsList()" title="Odśwież listę">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </div>

    <!-- Drugi rząd filtrów -->
    <div class="row g-3 mt-2">
        <!-- Technologia -->
        <div class="col-md-2">
            <label for="technology-filter" class="form-label">Technologia</label>
            <select id="technology-filter" class="form-select">
                <option value="">Wszystkie</option>
                <!-- Opcje będą ładowane dynamicznie -->
            </select>
        </div>

        <!-- Klasa drewna -->
        <div class="col-md-2">
            <label for="wood-class-filter" class="form-label">Klasa drewna</label>
            <select id="wood-class-filter" class="form-select">
                <option value="">Wszystkie</option>
                <!-- Opcje będą ładowane dynamicznie -->
            </select>
        </div>

        <!-- Klient -->
        <div class="col-md-3">
            <label for="client-filter" class="form-label">Klient</label>
            <input type="text" id="client-filter" class="form-control" placeholder="Nazwa klienta...">
        </div>

        <!-- Data od -->
        <div class="col-md-2">
            <label for="date-from" class="form-label">Data od</label>
            <input type="date" id="date-from" class="form-control">
        </div>

        <!-- Data do -->
        <div class="col-md-2">
            <label for="date-to" class="form-label">Data do</label>
            <input type="date" id="date-to" class="form-control">
        </div>

        <!-- Placeholder dla wyrównania -->
        <div class="col-md-1"></div>
    </div>
</div>

<!-- ============================================================================
     SMART SYSTEM AKTYWNYCH FILTRÓW - NOWY
     ============================================================================ -->
<div id="active-filters-container" class="active-filters-container mt-2 mb-3" style="display: none;">
    <!-- Badges z aktywnymi filtrami będą wstawiane tutaj przez JavaScript -->
</div>

<!-- ============================================================================
     STATYSTYKI FILTRÓW
     ============================================================================ -->
<div class="filter-stats-bar mt-3 mb-3" id="filter-stats-bar" style="display: none;">
    <div class="row g-3">
        <div class="col-md-3">
            <div class="stat-card stat-card-sm">
                <div class="stat-value" id="filter-total-count">0</div>
                <div class="stat-label">Produktów znalezionych</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card stat-card-sm">
                <div class="stat-value text-warning" id="filter-high-priority-count">0</div>
                <div class="stat-label">Wysoki priorytet</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card stat-card-sm">
                <div class="stat-value text-danger" id="filter-overdue-count">0</div>
                <div class="stat-label">Przeterminowane</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card stat-card-sm">
                <div class="stat-value text-info" id="filter-avg-priority">0</div>
                <div class="stat-label">Średni priorytet</div>
            </div>
        </div>
    </div>
</div>

<!-- ============================================================================
     BULK ACTIONS BAR
     ============================================================================ -->
<div class="bulk-actions-bar" id="bulk-actions-bar" style="display: none;">
    <div class="d-flex align-items-center justify-content-between">
        <div class="bulk-selection-info">
            <i class="fas fa-check-square text-white me-2"></i>
            <span id="bulk-count">0</span> produktów zaznaczonych
        </div>
        <div class="bulk-actions">
            <button class="btn btn-sm btn-outline-light me-2" id="bulk-update-status">
                <i class="fas fa-exchange-alt me-1"></i>Zmień status
            </button>
            {% if is_admin %}
            <button class="btn btn-sm btn-outline-light me-2" id="bulk-update-priority">
                <i class="fas fa-star me-1"></i>Ustaw priorytet
            </button>
            {% endif %}
            <button class="btn btn-sm btn-outline-light me-2" id="bulk-export">
                <i class="fas fa-download me-1"></i>Eksportuj
            </button>
            {% if is_admin %}
            <button class="btn btn-sm btn-outline-light" id="bulk-delete">
                <i class="fas fa-trash me-1"></i>Usuń
            </button>
            {% endif %}
        </div>
    </div>
</div>

<!-- ============================================================================
     TABELA PRODUKTÓW - NAPRAWIONA
     ============================================================================ -->
<div class="products-list mt-3" id="products-list">
    <div class="table-responsive">
        <table class="table table-hover products-table" id="products-table">
            <thead class="table-light sticky-top">
                <tr>
                    <!-- Checkbox dla bulk selection -->
                    <th width="40">
                        <input type="checkbox" id="select-all-checkbox" class="form-check-input" title="Zaznacz wszystkie">
                    </th>

                    <!-- Drag handle dla adminów -->
                    {% if is_admin %}
                    <th width="40" title="Przeciągnij aby zmienić priorytet">
                        <i class="fas fa-arrows-alt text-muted"></i>
                    </th>
                    {% endif %}

                    <!-- Sortowalne nagłówki -->
                    <th class="sortable-header" data-sort="priority_score" style="cursor: pointer;">
                        Priorytet <i class="fas fa-sort text-muted ms-1"></i>
                    </th>
                    <th class="sortable-header" data-sort="short_product_id" style="cursor: pointer;">
                        ID Produktu <i class="fas fa-sort text-muted ms-1"></i>
                    </th>
                    <th class="sortable-header" data-sort="original_product_name" style="cursor: pointer;">
                        Produkt <i class="fas fa-sort text-muted ms-1"></i>
                    </th>
                    <th class="text-center">Objętość</th>
                    <th class="text-center">Wartość</th>
                    <th class="sortable-header" data-sort="current_status" style="cursor: pointer;">
                        Status <i class="fas fa-sort text-muted ms-1"></i>
                    </th>
                    <th class="sortable-header" data-sort="deadline_date" style="cursor: pointer;">
                        Deadline <i class="fas fa-sort text-muted ms-1"></i>
                    </th>
                    <th width="120">Akcje</th>
                </tr>
            </thead>
            <tbody id="products-tbody" {% if is_admin %}class="sortable-products" {% endif %}>
                <!-- Produkty będą ładowane dynamicznie przez JavaScript -->
                {% if products %}
                {% for product in products %}
                <tr class="product-row"
                    data-product-id="{{ product.id }}"
                    data-priority="{{ product.priority_score or 0 }}"
                    data-status="{{ product.current_status }}">

                    <!-- Checkbox -->
                    <td>
                        <input type="checkbox" class="product-checkbox form-check-input bulk-select" value="{{ product.id }}">
                    </td>

                    <!-- Drag handle -->
                    {% if is_admin %}
                    <td class="drag-handle text-center">
                        <i class="fas fa-grip-vertical text-muted"></i>
                    </td>
                    {% endif %}

                    <!-- Priority -->
                    <td class="priority-cell">
                        <div class="priority-container">
                            {% set priority = product.priority_score or 0 %}
                            {% if priority >= 150 %}
                            {% set priority_class = 'priority-critical' %}
                            {% elif priority >= 120 %}
                            {% set priority_class = 'priority-high' %}
                            {% elif priority >= 80 %}
                            {% set priority_class = 'priority-medium' %}
                            {% else %}
                            {% set priority_class = 'priority-low' %}
                            {% endif %}

                            <span class="priority-score {{ priority_class }}"
                                  {% if is_admin %}onclick="editPriorityInline({{ product.id }}, this)" {% endif %}
                                  title="{% if is_admin %}Kliknij aby edytować{% else %}Priorytet produktu{% endif %}">
                                {{ priority }}
                            </span>
                            <div class="priority-bar">
                                <div class="priority-fill" style="width: {{ (priority / 2)|round(1) }}%"></div>
                            </div>
                        </div>
                    </td>

                    <!-- Product ID -->
                    <td class="product-id-cell">
                        <div class="product-id-container">
                            <span class="product-id-main fw-bold">{{ product.short_product_id or product.id }}</span>
                            {% if product.internal_order_number %}
                            <br><small class="text-muted">{{ product.internal_order_number }}</small>
                            {% endif %}
                            {% if product.baselinker_order_id %}
                            <br><small class="text-info">BaseID: {{ product.baselinker_order_id }}</small>
                            {% endif %}
                        </div>
                    </td>

                    <!-- Product details -->
                    <td class="product-cell">
                        <div class="product-info">
                            <div class="product-name" title="{{ product.original_product_name }}">
                                {{ product.original_product_name[:60] }}{% if product.original_product_name|length > 60 %}...{% endif %}
                            </div>
                            {% if product.parsed_wood_species or product.parsed_technology %}
                            <div class="product-specs">
                                {% if product.parsed_wood_species %}
                                <span class="spec-badge spec-species">{{ product.parsed_wood_species }}</span>
                                {% endif %}
                                {% if product.parsed_technology %}
                                <span class="spec-badge spec-tech">{{ product.parsed_technology }}</span>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </td>

                    <!-- Volume -->
                    <td class="volume-cell text-center">
                        {% if product.volume_m3 %}
                        <span class="volume-value">{{ "%.3f"|format(product.volume_m3) }} m³</span>
                        {% else %}
                        <span class="text-muted">-</span>
                        {% endif %}
                    </td>

                    <!-- Value -->
                    <td class="value-cell text-center">
                        {% if product.total_value_net %}
                        <span class="value-amount fw-bold">{{ "{:,.2f}"|format(product.total_value_net) }} zł</span>
                        {% elif product.unit_price_net and product.volume_m3 %}
                        <span class="value-amount">{{ "{:,.2f}"|format(product.unit_price_net * product.volume_m3) }} zł</span>
                        {% else %}
                        <span class="text-muted">-</span>
                        {% endif %}
                    </td>

                    <!-- Status -->
                    <td class="status-cell text-center">
                        {% set status_class = 'status-' + product.current_status.replace('czeka_na_', '').replace('_', '-') %}
                        <span class="status-badge {{ status_class }}">
                            {% if product.current_status == 'czeka_na_wyciecie' %}Wycinanie
                            {% elif product.current_status == 'czeka_na_skladanie' %}Składanie
                            {% elif product.current_status == 'czeka_na_pakowanie' %}Pakowanie
                            {% elif product.current_status == 'spakowane' %}Spakowane
                            {% else %}{{ product.current_status.replace('_', ' ').title() }}
                            {% endif %}
                        </span>
                    </td>

                    <!-- Deadline -->
                    <td class="deadline-cell text-center">
                        {% if product.deadline_date %}
                        {% set deadline_date = product.deadline_date %}
                        {% set today_date = today %}
                        {% set days_diff = (deadline_date - today_date).days %}

                        {% if days_diff < 0 %}
                        <span class="deadline-badge deadline-overdue text-danger">
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            {{ (days_diff|abs) }} dni temu
                        </span>
                        {% elif days_diff == 0 %}
                        <span class="deadline-badge deadline-today text-warning">
                            <i class="fas fa-clock me-1"></i>
                            Dzisiaj
                        </span>
                        {% elif days_diff <= 2 %}
                        <span class="deadline-badge deadline-urgent text-warning">
                            <i class="fas fa-exclamation me-1"></i>
                            Za {{ days_diff }} dni
                        </span>
                        {% elif days_diff <= 7 %}
                        <span class="deadline-badge deadline-warning text-info">
                            Za {{ days_diff }} dni
                        </span>
                        {% else %}
                        <span class="deadline-badge deadline-normal text-success">
                            Za {{ days_diff }} dni
                        </span>
                        {% endif %}
                        <br><small class="text-muted">{{ deadline_date.strftime('%d.%m.%Y') }}</small>
                        {% else %}
                        <span class="text-muted">-</span>
                        {% endif %}
                    </td>

                    <!-- Actions -->
                    <td class="actions-cell">
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-primary" onclick="ProductModal.openModal && ProductModal.openModal({{ product.id }})" title="Szczegóły">
                                <i class="fas fa-eye"></i>
                            </button>
                            <a href="https://panel-f.baselinker.com/orders.php#order:{{ product.baselinker_order_id }}"
                               target="_blank" class="btn btn-sm btn-outline-info" title="Baselinker">
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                            {% if is_admin %}
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle"
                                        type="button"
                                        data-bs-toggle="dropdown">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li>
                                        <a class="dropdown-item" href="#" onclick="editProductPriority({{ product.id }})">
                                            <i class="fas fa-star me-2"></i>Edytuj priorytet
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="#" onclick="changeProductStatus({{ product.id }})">
                                            <i class="fas fa-exchange-alt me-2"></i>Zmień status
                                        </a>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <a class="dropdown-item text-danger" href="#" onclick="deleteProduct({{ product.id }})">
                                            <i class="fas fa-trash me-2"></i>Usuń produkt
                                        </a>
                                    </li>
                                </ul>
                            </div>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="10" class="text-center py-5">
                        <div class="no-products-message">
                            <i class="fas fa-search fa-3x text-muted mb-3"></i>
                            <h5>Brak produktów</h5>
                            <p class="text-muted">Nie znaleziono produktów spełniających kryteria filtrowania.</p>
                            <button class="btn btn-outline-primary" onclick="AdvancedFilters.clearAllFilters()">
                                Wyczyść filtry
                            </button>
                        </div>
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- ============================================================================
         PAGINACJA
         ============================================================================ -->
    <div class="pagination-container mt-4" id="pagination-container">
        <div class="row align-items-center">
            <div class="col-md-4">
                <div class="pagination-info">
                    Pokazano <span id="items-from">1</span> - <span id="items-to">{{ products|length }}</span>
                    z <span id="total-items">{{ products|length }}</span> produktów
                </div>
            </div>
            <div class="col-md-4 text-center">
                <div class="pagination-controls">
                    <button class="btn btn-outline-secondary btn-sm" id="prev-page" disabled>
                        <i class="fas fa-chevron-left"></i> Poprzednia
                    </button>
                    <span class="page-numbers mx-3" id="page-numbers">
                        <button class="btn btn-primary btn-sm page-btn" data-page="1" disabled>1</button>
                    </span>
                    <button class="btn btn-outline-secondary btn-sm" id="next-page" disabled>
                        Następna <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-4 text-end">
                <div class="pagination-actions">
                    <button class="btn btn-outline-success btn-sm me-2" id="export-btn" title="Eksportuj produkty">
                        <i class="fas fa-download"></i> Eksport
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="refreshProductsList()" title="Odśwież listę">
                        <i class="fas fa-sync-alt"></i> Odśwież
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ============================================================================
     JAVASCRIPT INITIALIZATION - UPROSZCZONY
     ============================================================================ -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log('[Products Tab HTML] DOM załadowany...');

        // Sprawdź czy główny JS jest załadowany
        if (typeof ProductsList !== 'undefined' && typeof AdvancedFilters !== 'undefined') {
            console.log('[Products Tab HTML] Główny JS wykryty - deleguje inicjalizację');
            // Główny JS przejmuje kontrolę
        } else {
            console.log('[Products Tab HTML] Główny JS nie wykryty - podstawowy fallback');
            setupBasicFallback();
        }
    });

    // Podstawowy fallback tylko jeśli główny JS nie działa
    function setupBasicFallback() {
        // Search input
        const searchInput = document.getElementById('search-input');
        if (searchInput) {
            searchInput.addEventListener('input', function () {
                console.log('[Fallback] Search input:', this.value);
                basicClientSideFilter();
            });
        }

        // Status filter
        const statusFilter = document.getElementById('status-filter');
        if (statusFilter) {
            statusFilter.addEventListener('change', function () {
                console.log('[Fallback] Status filter:', this.value);
                basicClientSideFilter();
            });
        }

        // Clear search
        const clearBtn = document.getElementById('clear-search-btn');
        if (clearBtn) {
            clearBtn.addEventListener('click', function () {
                if (searchInput) {
                    searchInput.value = '';
                    basicClientSideFilter();
                }
            });
        }
    }

    // Podstawowe filtrowanie po stronie klienta (fallback)
    function basicClientSideFilter() {
        const searchInput = document.getElementById('search-input');
        const statusFilter = document.getElementById('status-filter');
        const rows = document.querySelectorAll('.product-row');

        const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
        const selectedStatus = statusFilter ? statusFilter.value : 'all';

        let visibleCount = 0;

        rows.forEach(row => {
            let show = true;

            // Search filter
            if (searchTerm) {
                const productName = row.querySelector('.product-name')?.textContent?.toLowerCase() || '';
                const productId = row.querySelector('.product-id-main')?.textContent?.toLowerCase() || '';

                if (!productName.includes(searchTerm) && !productId.includes(searchTerm)) {
                    show = false;
                }
            }

            // Status filter
            if (selectedStatus !== 'all') {
                const rowStatus = row.dataset.status;
                if (rowStatus !== selectedStatus) {
                    show = false;
                }
            }

            row.style.display = show ? '' : 'none';
            if (show) visibleCount++;
        });

        console.log(`[Fallback] Pokazano ${visibleCount} produktów`);

        // Aktualizuj licznik jeśli istnieje
        const totalElement = document.getElementById('total-items');
        if (totalElement) {
            totalElement.textContent = visibleCount;
        }
    }

    // Funkcja odświeżania dla przycisku (fallback)
    function refreshProductsList() {
        console.log('[Fallback] Odświeżanie listy produktów...');

        // Sprawdź czy główny system jest dostępny
        if (typeof AdvancedFilters !== 'undefined' && AdvancedFilters.applyFilters) {
            AdvancedFilters.applyFilters();
        } else {
            // Fallback - reload strony
            window.location.reload();
        }
    }
</script>