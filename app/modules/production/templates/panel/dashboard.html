<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Produkcji - WoodPower CRM</title>
    <link rel="icon" href="{{ url_for('static', filename='images/favicon.png') }}" type="image/png">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('production.static', filename='css/production-panel.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar systemowy -->
        {% include 'sidebar/sidebar.html' %}

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <div class="dashboard-header">
                <div class="header-top">
                    <h1 class="page-title title-with-underline">Dashboard Produkcji</h1>

                    <div class="user-greeting">
                        <div class="production-status" id="production-status">
                            <span class="status-indicator" id="status-indicator"></span>
                            <span class="status-text" id="status-text">Ładowanie...</span>
                        </div>
                        <div class="system-status">
                            {% if current_user.role in ['admin', 'administrator'] %}
                            <div class="system-refresh-section">
                                <button class="refresh-system-btn" id="refresh-system-btn" onclick="refreshSystemWithTimer()">
                                    <span class="refresh-icon">🔄</span>
                                    <span class="refresh-text">Odśwież system</span>
                                    <span class="refresh-timer" id="refresh-timer" style="display:none;"></span>
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Production Dashboard Tabs -->
            <div class="production-dashboard-tabs">
                <!-- Tab Navigation -->
                <nav class="nav nav-tabs dashboard-nav-tabs" id="productionDashboardTabs" role="tablist">
                    <button class="nav-link active" 
                            id="dashboard-tab" 
                            data-bs-toggle="tab" 
                            data-bs-target="#dashboard-tab-content" 
                            type="button" 
                            role="tab" 
                            aria-controls="dashboard-tab-content" 
                            aria-selected="true" 
                            onclick="loadTabContent('dashboard-tab')">
                        <i class="fas fa-tachometer-alt me-2"></i>
                        Dashboard
                    </button>
                    
                    <button class="nav-link" 
                            id="products-tab" 
                            data-bs-toggle="tab" 
                            data-bs-target="#products-tab-content" 
                            type="button" 
                            role="tab" 
                            aria-controls="products-tab-content" 
                            aria-selected="false"
                            onclick="loadTabContent('products-tab')">
                        <i class="fas fa-list me-2"></i>
                        Lista produktów
                    </button>
                    
                    <button class="nav-link" 
                            id="reports-tab" 
                            data-bs-toggle="tab" 
                            data-bs-target="#reports-tab-content" 
                            type="button" 
                            role="tab" 
                            aria-controls="reports-tab-content" 
                            aria-selected="false"
                            onclick="loadTabContent('reports-tab')">
                        <i class="fas fa-chart-bar me-2"></i>
                        Raporty
                    </button>
                    
                    <button class="nav-link" 
                            id="stations-tab" 
                            data-bs-toggle="tab" 
                            data-bs-target="#stations-tab-content" 
                            type="button" 
                            role="tab" 
                            aria-controls="stations-tab-content" 
                            aria-selected="false"
                            onclick="loadTabContent('stations-tab')">
                        <i class="fas fa-industry me-2"></i>
                        Stanowiska
                    </button>
                    
                    {% if current_user.role in ['admin', 'administrator'] %}
                    <button class="nav-link" 
                            id="config-tab" 
                            data-bs-toggle="tab" 
                            data-bs-target="#config-tab-content" 
                            type="button" 
                            role="tab" 
                            aria-controls="config-tab-content" 
                            aria-selected="false"
                            onclick="loadTabContent('config-tab')">
                        <i class="fas fa-cog me-2"></i>
                        Konfiguracja
                    </button>
                    {% endif %}
                </nav>

                <!-- Tab Content Container -->
                <div class="tab-content production-tab-content" id="productionDashboardTabContent">
                    
                    <!-- Dashboard Tab -->
                    <div class="tab-pane fade show active" 
                         id="dashboard-tab-content" 
                         role="tabpanel" 
                         aria-labelledby="dashboard-tab">
                        
                        <div class="tab-loading" id="dashboard-tab-loading">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
                                <p class="mt-3 text-muted">Ładowanie dashboard...</p>
                            </div>
                        </div>
                        
                        <div class="tab-content-wrapper" id="dashboard-tab-wrapper" style="display:none;">
                            <!-- Zawartość dashboard zostanie załadowana przez AJAX -->
                        </div>
                        
                        <div class="tab-error" id="dashboard-tab-error" style="display:none;">
                            <div class="alert alert-danger" role="alert">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Błąd ładowania dashboard!</strong> 
                                <span id="dashboard-tab-error-message"></span>
                                <button class="btn btn-outline-danger btn-sm ms-2" onclick="loadTabContent('dashboard-tab')">
                                    <i class="fas fa-redo me-1"></i>Spróbuj ponownie
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Products Tab -->
                    <div class="tab-pane fade" 
                         id="products-tab-content" 
                         role="tabpanel" 
                         aria-labelledby="products-tab">
                        
                        <div class="tab-loading" id="products-tab-loading">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
                                <p class="mt-3 text-muted">Ładowanie listy produktów...</p>
                            </div>
                        </div>
                        
                        <div class="tab-content-wrapper" id="products-tab-wrapper" style="display:none;">
                            <!-- Zawartość produktów zostanie załadowana przez AJAX -->
                        </div>
                        
                        <div class="tab-error" id="products-tab-error" style="display:none;">
                            <div class="alert alert-danger" role="alert">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Błąd ładowania produktów!</strong> 
                                <span id="products-tab-error-message"></span>
                                <button class="btn btn-outline-danger btn-sm ms-2" onclick="loadTabContent('products-tab')">
                                    <i class="fas fa-redo me-1"></i>Spróbuj ponownie
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Reports Tab -->
                    <div class="tab-pane fade" 
                         id="reports-tab-content" 
                         role="tabpanel" 
                         aria-labelledby="reports-tab">
                        
                        <div class="tab-loading" id="reports-tab-loading">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
                                <p class="mt-3 text-muted">Ładowanie raportów...</p>
                            </div>
                        </div>
                        
                        <div class="tab-content-wrapper" id="reports-tab-wrapper" style="display:none;">
                            <!-- Zawartość raportów zostanie załadowana przez AJAX -->
                        </div>
                        
                        <div class="tab-error" id="reports-tab-error" style="display:none;">
                            <div class="alert alert-danger" role="alert">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Błąd ładowania raportów!</strong> 
                                <span id="reports-tab-error-message"></span>
                                <button class="btn btn-outline-danger btn-sm ms-2" onclick="loadTabContent('reports-tab')">
                                    <i class="fas fa-redo me-1"></i>Spróbuj ponownie
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Stations Tab -->
                    <div class="tab-pane fade" 
                         id="stations-tab-content" 
                         role="tabpanel" 
                         aria-labelledby="stations-tab">
                        
                        <div class="tab-loading" id="stations-tab-loading">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
                                <p class="mt-3 text-muted">Ładowanie stanowisk...</p>
                            </div>
                        </div>
                        
                        <div class="tab-content-wrapper" id="stations-tab-wrapper" style="display:none;">
                            <!-- Zawartość stanowisk zostanie załadowana przez AJAX -->
                        </div>
                        
                        <div class="tab-error" id="stations-tab-error" style="display:none;">
                            <div class="alert alert-danger" role="alert">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Błąd ładowania stanowisk!</strong> 
                                <span id="stations-tab-error-message"></span>
                                <button class="btn btn-outline-danger btn-sm ms-2" onclick="loadTabContent('stations-tab')">
                                    <i class="fas fa-redo me-1"></i>Spróbuj ponownie
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Config Tab (tylko admin) -->
                    {% if current_user.role in ['admin', 'administrator'] %}
                    <div class="tab-pane fade" 
                         id="config-tab-content" 
                         role="tabpanel" 
                         aria-labelledby="config-tab">
                        
                        <div class="tab-loading" id="config-tab-loading">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
                                <p class="mt-3 text-muted">Ładowanie konfiguracji...</p>
                            </div>
                        </div>
                        
                        <div class="tab-content-wrapper" id="config-tab-wrapper" style="display:none;">
                            <!-- Zawartość konfiguracji zostanie załadowana przez AJAX -->
                        </div>
                        
                        <div class="tab-error" id="config-tab-error" style="display:none;">
                            <div class="alert alert-danger" role="alert">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Błąd ładowania konfiguracji!</strong> 
                                <span id="config-tab-error-message"></span>
                                <button class="btn btn-outline-danger btn-sm ms-2" onclick="loadTabContent('config-tab')">
                                    <i class="fas fa-redo me-1"></i>Spróbuj ponownie
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                </div>
            </div>
        </main>
    </div>

    <!-- Skrypty -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/sidebar.js') }}"></script>
    <script src="{{ url_for('production.static', filename='js/production-dashboard.js') }}"></script>
    
    {% if current_user.role in ['admin', 'administrator'] %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    {% endif %}

    <script>
        // Konfiguracja globalnych zmiennych
        window.productionConfig = {
            currentUser: {
                role: '{{ current_user.role if current_user.is_authenticated else "guest" }}',
                id: {{ current_user.id if current_user.is_authenticated else 'null' }}
            },
            endpoints: {
                dashboardTabContent: '{{ url_for("production.production_api.dashboard_tab_content") }}',
                productsTabContent: '{{ url_for("production.production_api.products_tab_content") }}',
                reportsTabContent: '{{ url_for("production.production_api.reports_tab_content") }}',
                stationsTabContent: '{{ url_for("production.production_api.stations_tab_content") }}',
                configTabContent: '{{ url_for("production.production_api.config_tab_content") }}',
                dashboardStats: '{{ url_for("production.production_api.dashboard_stats") }}',
                manualSync: '{{ url_for("production.production_api.manual_sync") }}'
            }
        };

        // Stan aplikacji
        let refreshInterval;
        let currentActiveTab = 'dashboard-tab';
        const REFRESH_INTERVAL_MS = 180000; // 3 minuty = 180000ms
        
        // Inicjalizacja po załadowaniu strony
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Production Dashboard z tabami - inicjalizacja');
            
            // Załaduj pierwszy tab
            loadTabContent('dashboard-tab');
            
            // Ustaw auto-refresh co 3 minuty dla aktywnego taba
            refreshInterval = setInterval(() => {
                if (currentActiveTab) {
                    console.log(`Auto-refresh dla taba: ${currentActiveTab} (co 3min)`);
                    loadTabContent(currentActiveTab, true); // true = silent refresh
                }
            }, REFRESH_INTERVAL_MS);
            
            console.log(`Auto-refresh ustawiony na ${REFRESH_INTERVAL_MS/1000/60} minut`);
        });

        // Główna funkcja ładowania zawartości tabów przez AJAX
        async function loadTabContent(tabName, silentRefresh = false) {
            currentActiveTab = tabName;
            console.log(`Ładowanie taba: ${tabName}, silent: ${silentRefresh}`);

            const loadingElement = document.getElementById(`${tabName}-loading`);
            const wrapperElement = document.getElementById(`${tabName}-wrapper`);
            const errorElement = document.getElementById(`${tabName}-error`);

            // Pokaż loading tylko jeśli nie jest to silent refresh
            if (!silentRefresh) {
                loadingElement.style.display = 'block';
                wrapperElement.style.display = 'none';
                errorElement.style.display = 'none';
            }

            try {
                // Określ endpoint na podstawie nazwy taba
                let endpointKey;
                if (tabName === 'dashboard-tab') endpointKey = 'dashboardTabContent';
                else if (tabName === 'products-tab') endpointKey = 'productsTabContent';
                else if (tabName === 'reports-tab') endpointKey = 'reportsTabContent';
                else if (tabName === 'stations-tab') endpointKey = 'stationsTabContent';
                else if (tabName === 'config-tab') endpointKey = 'configTabContent';
                else throw new Error(`Nieznany tab: ${tabName}`);
                
                const endpoint = window.productionConfig.endpoints[endpointKey];
                
                if (!endpoint) {
                    throw new Error(`Brak endpointu dla taba: ${tabName}`);
                }

                const response = await fetch(endpoint, {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Nieznany błąd API');
                }

                // Wstaw otrzymaną zawartość HTML
                wrapperElement.innerHTML = data.html;
                
                // Ukryj loading, pokaż zawartość
                loadingElement.style.display = 'none';
                wrapperElement.style.display = 'block';
                errorElement.style.display = 'none';

                // Wykonaj callback dla specjalnych funkcji taba
                const callbackName = `on${tabName.replace('-tab', '').charAt(0).toUpperCase() + tabName.replace('-tab', '').slice(1)}TabLoaded`;
                if (typeof window[callbackName] === 'function') {
                    window[callbackName](data);
                }

                console.log(`Tab ${tabName} załadowany pomyślnie`);

            } catch (error) {
                console.error(`Błąd ładowania taba ${tabName}:`, error);
                
                // Pokaż błąd
                loadingElement.style.display = 'none';
                wrapperElement.style.display = 'none';
                errorElement.style.display = 'block';
                document.getElementById(`${tabName}-error-message`).textContent = error.message;
            }
        }

        // Callbacki dla poszczególnych tabów
        window.onDashboardTabLoaded = function(data) {
            console.log('Dashboard tab loaded, initializing widgets...');
            if (window.productionConfig.currentUser.role === 'admin') {
                initializeCharts();
            }
            initializeDashboardWidgets();
        };

        window.onProductsTabLoaded = function(data) {
            console.log('Products tab loaded, initializing filters...');
            initializeProductFilters();
            if (window.productionConfig.currentUser.role === 'admin') {
                initializeDragAndDrop();
            }
        };

        window.onReportsTabLoaded = function(data) {
            console.log('Reports tab loaded, initializing reports...');
            initializeReports();
        };

        window.onStationsTabLoaded = function(data) {
            console.log('Stations tab loaded, initializing stations...');
            initializeStations();
        };

        window.onConfigTabLoaded = function(data) {
            console.log('Config tab loaded, initializing forms...');
            initializeConfigForms();
        };

        // System odświeżania z timerem
        function refreshSystemWithTimer() {
            const btn = document.getElementById('refresh-system-btn');
            const timer = document.getElementById('refresh-timer');
            
            // Zablokuj przycisk
            btn.disabled = true;
            timer.style.display = 'inline';
            
            let seconds = 5;
            timer.textContent = `(${seconds}s)`;
            
            // Odśwież aktywny tab
            loadTabContent(currentActiveTab);
            
            // Odliczanie
            const countdown = setInterval(() => {
                seconds--;
                timer.textContent = `(${seconds}s)`;
                
                if (seconds <= 0) {
                    clearInterval(countdown);
                    btn.disabled = false;
                    timer.style.display = 'none';
                }
            }, 1000);
        }

        // Placeholder functions - zostaną zaimplementowane później
        function initializeCharts() { console.log('TODO: Initialize charts'); }
        function initializeDashboardWidgets() { console.log('TODO: Initialize dashboard widgets'); }
        function initializeProductFilters() { console.log('TODO: Initialize product filters'); }
        function initializeDragAndDrop() { console.log('TODO: Initialize drag and drop'); }
        function initializeReports() { console.log('TODO: Initialize reports'); }
        function initializeStations() { console.log('TODO: Initialize stations'); }
        function initializeConfigForms() { console.log('TODO: Initialize config forms'); }

        // Status systemu
        function updateSystemStatus(status, message) {
            const indicator = document.getElementById('status-indicator');
            const text = document.getElementById('status-text');
            
            indicator.className = `status-indicator ${status}`;
            text.textContent = message;
        }

        // Początkowy status
        updateSystemStatus('loading', 'Inicjalizacja systemu...');
    </script>
</body>
</html>