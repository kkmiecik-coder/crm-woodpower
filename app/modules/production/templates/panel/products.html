<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Lista Produkt√≥w - WoodPower CRM</title>
    <link rel="icon" href="{{ url_for('static', filename='images/favicon.png') }}" type="image/png">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('production.static', filename='css/production-panel.css') }}">
    <link rel="stylesheet" href="{{ url_for('production.static', filename='css/station-grid.css') }}">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar systemowy -->
        {% include 'sidebar/sidebar.html' %}

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <div class="dashboard-header">
                <div class="header-top">
                    <h1 class="page-title title-with-underline">Lista Produkt√≥w Produkcyjnych</h1>

                    <!-- Quick Actions Bar -->
                    <div class="quick-actions-bar">
                        <div class="quick-actions-list">
                            <a href="{{ url_for('production_main.dashboard') }}" class="quick-action-btn">
                                <span class="quick-action-icon">üè†</span>
                                Dashboard
                            </a>
                            <button id="refresh-products-btn" class="quick-action-btn" onclick="refreshProductsList()">
                                <span class="quick-action-icon">üîÑ</span>
                                Od≈õwie≈º
                            </button>
                            {% if is_admin %}
                            <button id="save-priorities-btn" class="quick-action-btn" onclick="savePriorities()" style="display: none;">
                                <span class="quick-action-icon">üíæ</span>
                                Zapisz Priorytety
                            </button>
                            {% endif %}
                            <button id="export-btn" class="quick-action-btn" onclick="exportProducts()">
                                <span class="quick-action-icon">üìä</span>
                                Eksport
                            </button>
                        </div>
                    </div>

                    <div class="user-greeting">
                        <div class="products-summary">
                            <span class="products-count" id="products-count">{{ products|length }} produkt√≥w</span>
                            <span class="last-updated" id="products-updated">Aktualizacja: teraz</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filtry i wyszukiwanie -->
            <div class="products-filters">
                <div class="filters-row">
                    <!-- Wyszukiwanie -->
                    <div class="filter-group search-group">
                        <label for="search-input">Wyszukaj:</label>
                        <input type="text" id="search-input" class="form-control"
                               placeholder="ID zam√≥wienia, nazwa produktu, klient..."
                               value="{{ search_query or '' }}"
                               oninput="filterProducts()">
                        <button type="button" class="btn btn-outline-secondary" onclick="clearSearch()">
                            ‚úï
                        </button>
                    </div>

                    <!-- Filtr statusu -->
                    <div class="filter-group">
                        <label for="status-filter">Status:</label>
                        <select id="status-filter" class="form-select" onchange="filterProducts()">
                            {% for value, label in status_options %}
                            <option value="{{ value }}" {{ 'selected' if status_filter == value else '' }}>
                                {{ label }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Filtr stanowiska -->
                    <div class="filter-group">
                        <label for="station-filter">Stanowisko:</label>
                        <select id="station-filter" class="form-select" onchange="filterProducts()">
                            <option value="all">Wszystkie</option>
                            <option value="cutting">Wycinanie</option>
                            <option value="assembly">Sk≈Çadanie</option>
                            <option value="packaging">Pakowanie</option>
                        </select>
                    </div>

                    <!-- Filtr deadline -->
                    <div class="filter-group">
                        <label for="deadline-filter">Deadline:</label>
                        <select id="deadline-filter" class="form-select" onchange="filterProducts()">
                            <option value="all">Wszystkie</option>
                            <option value="overdue">Przeterminowane</option>
                            <option value="urgent">Pilne (‚â§2 dni)</option>
                            <option value="soon">Wkr√≥tce (‚â§7 dni)</option>
                            <option value="normal">Normalne (>7 dni)</option>
                        </select>
                    </div>

                    <!-- Sortowanie -->
                    <div class="filter-group">
                        <label for="sort-by">Sortuj:</label>
                        <select id="sort-by" class="form-select" onchange="sortProducts()">
                            <option value="priority">Priorytet</option>
                            <option value="deadline">Deadline</option>
                            <option value="created_at">Data utworzenia</option>
                            <option value="order_id">ID zam√≥wienia</option>
                        </select>
                    </div>
                </div>

                <!-- Stats row -->
                <div class="filters-stats">
                    <div class="stats-item">
                        <span class="stat-label">Wy≈õwietlane:</span>
                        <span class="stat-value" id="visible-count">{{ products|length }}</span>
                    </div>
                    <div class="stats-item">
                        <span class="stat-label">Przeterminowane:</span>
                        <span class="stat-value overdue" id="overdue-count">0</span>
                    </div>
                    <div class="stats-item">
                        <span class="stat-label">Pilne:</span>
                        <span class="stat-value urgent" id="urgent-count">0</span>
                    </div>
                    {% if is_admin %}
                    <div class="stats-item">
                        <span class="stat-label">Drag & Drop:</span>
                        <span class="stat-value admin">W≈ÇƒÖczony</span>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Lista produkt√≥w -->
            <div class="products-container">
                {% if products %}
                <div class="products-table-container">
                    <table class="products-table" id="products-table">
                        <thead>
                            <tr>
                                {% if is_admin %}
                                <th class="priority-col">
                                    <span class="priority-header">
                                        <span class="priority-icon">üìå</span>
                                        Priorytet
                                    </span>
                                </th>
                                {% endif %}
                                <th class="order-id-col">ID Zam√≥wienia</th>
                                <th class="product-col">Produkt</th>
                                <th class="client-col">Klient</th>
                                <th class="created-col">Data utworzenia</th>
                                <th class="status-col">Status</th>
                                <th class="deadline-col">Deadline</th>
                                <th class="actions-col">Akcje</th>
                            </tr>
                        </thead>
                        <tbody id="products-tbody" class="{% if is_admin %}sortable-products{% endif %}">
                            {% for product in products %}
                            <tr class="product-row"
                                data-product-id="{{ product.id }}"
                                data-order-id="{{ product.internal_order_number }}"
                                data-client="{{ product.client_name or '' }}"
                                data-status="{{ product.current_status }}"
                                data-deadline="{{ product.deadline_date.isoformat() if product.deadline_date else '' }}"
                                data-priority="{{ product.priority_score or 0 }}"
                                data-created="{{ product.created_at.isoformat() if product.created_at else '' }}">

                                {% if is_admin %}
                                <td class="priority-cell">
                                    <div class="priority-container">
                                        <div class="drag-handle">‚ãÆ‚ãÆ</div>
                                        <div class="priority-value">
                                            <span class="priority-score" data-original="{{ product.priority_score or 0 }}">
                                                {{ product.priority_score or 0 }}
                                            </span>
                                            <div class="priority-bar">
                                                <div class="priority-fill" style="width: {{ (product.priority_score or 0) / 2 }}%"></div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                {% endif %}

                                <td class="order-id-cell">
                                    <div class="order-id-container">
                                        <span class="order-id-main">{{ product.internal_order_number }}</span>
                                        {% if product.baselinker_order_id %}
                                        <span class="order-id-original">BL: {{ product.baselinker_order_id }}</span>
                                        {% endif %}
                                    </div>
                                </td>

                                <td class="product-cell">
                                    <div class="product-info">
                                        <div class="product-name">{{ product.original_product_name[:50] }}{% if product.original_product_name|length > 50 %}...{% endif %}</div>
                                        {% if product.parsed_data %}
                                        <div class="product-specs">
                                            {% if product.parsed_data.get('dimensions') %}
                                            <span class="spec-item">{{ product.parsed_data.dimensions }}</span>
                                            {% endif %}
                                            {% if product.parsed_data.get('volume_m3') %}
                                            <span class="spec-item">{{ product.parsed_data.volume_m3 }} m¬≥</span>
                                            {% endif %}
                                            {% if product.parsed_data.get('wood_species') %}
                                            <span class="spec-item">{{ product.parsed_data.wood_species }}</span>
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </td>

                                <td class="client-cell">
                                    <div class="client-info">
                                        <span class="client-name">{{ product.client_name or 'Nieznany' }}</span>
                                    </div>
                                </td>

                                <td class="created-cell">
                                    <div class="date-info">
                                        <span class="date-main">{{ product.created_at.strftime('%d.%m.%Y') if product.created_at else '' }}</span>
                                        <span class="date-time">{{ product.created_at.strftime('%H:%M') if product.created_at else '' }}</span>
                                    </div>
                                </td>

                                <td class="status-cell">
                                    <span class="status-badge status-{{ product.current_status.replace('_', '-') if product.current_status else 'unknown' }}">
                                        {{ get_status_display(product.current_status) }}
                                    </span>
                                </td>

                                <td class="deadline-cell">
                                    {% if product.deadline_date %}
                                    {% set days_remaining = (product.deadline_date.date() - today) | days_difference %}
                                    <div class="deadline-info">
                                        <span class="deadline-date">{{ product.deadline_date.strftime('%d.%m.%Y') }}</span>
                                        <span class="deadline-remaining deadline-{{ 'overdue' if days_remaining < 0 else ('urgent' if days_remaining <= 2 else 'normal') }}">
                                            {% if days_remaining < 0 %}
                                            {{ -days_remaining }} dni po terminie
                                            {% elif days_remaining == 0 %}
                                            Dzisiaj
                                            {% else %}
                                            {{ days_remaining }} dni
                                            {% endif %}
                                        </span>
                                    </div>
                                    {% else %}
                                    <span class="no-deadline">Brak terminu</span>
                                    {% endif %}
                                </td>

                                <td class="actions-cell">
                                    <div class="product-actions">
                                        <button class="action-btn view-btn" onclick="viewProduct('{{ product.id }}')"
                                                title="Szczeg√≥≈Çy produktu">
                                            üëÅÔ∏è
                                        </button>
                                        {% if is_admin %}
                                        <button class="action-btn edit-btn" onclick="editProduct('{{ product.id }}')"
                                                title="Edytuj produkt">
                                            ‚úèÔ∏è
                                        </button>
                                        <button class="action-btn priority-btn" onclick="setPriority('{{ product.id }}')"
                                                title="Ustaw priorytet">
                                            üìå
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="no-products">
                    <div class="no-products-icon">üìã</div>
                    <h3>Brak produkt√≥w</h3>
                    <p>Nie znaleziono produkt√≥w spe≈ÇniajƒÖcych kryteria wyszukiwania.</p>
                    <button class="btn btn-primary" onclick="clearAllFilters()">
                        Wyczy≈õƒá filtry
                    </button>
                </div>
                {% endif %}
            </div>
        </main>
    </div>

    <!-- Modal szczeg√≥≈Ç√≥w produktu -->
    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Szczeg√≥≈Çy Produktu</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="productModalBody">
                    <!-- Zawarto≈õƒá ≈Çadowana dynamicznie -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zamknij</button>
                </div>
            </div>
        </div>
    </div>

    {% if is_admin %}
    <!-- Modal ustawiania priorytetu -->
    <div class="modal fade" id="priorityModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ustaw Priorytet</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="priorityForm">
                        <div class="mb-3">
                            <label for="priorityValue" class="form-label">Nowy priorytet (0-200):</label>
                            <input type="number" class="form-control" id="priorityValue"
                                   min="0" max="200" step="1" required>
                            <div class="form-text">
                                0 = najni≈ºszy, 200 = najwy≈ºszy priorytet
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="priorityReason" class="form-label">Pow√≥d zmiany:</label>
                            <textarea class="form-control" id="priorityReason" rows="2"
                                      placeholder="Opcjonalny pow√≥d zmiany priorytetu"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                    <button type="button" class="btn btn-primary" onclick="savePriorityChange()">Zapisz</button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Skrypty -->
    <script src="{{ url_for('static', filename='js/sidebar.js') }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    {% if is_admin %}
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    {% endif %}

    <script>
        // Przekazujemy dane z backendu do JavaScript
        window.productsData = {
            products: {{ products|tojson if products else []|tojson }},
            isAdmin: {{ is_admin|tojson }},
            statusOptions: {{ status_options|tojson }},
            currentFilters: {
                status: '{{ status_filter or "all" }}',
                search: '{{ search_query or "" }}'
            }
        };

        window.currentUser = {
            role: '{{ current_user.role if current_user.is_authenticated else "guest" }}',
            id: {{ current_user.id if current_user.is_authenticated else 'null' }}
        };

        console.log('[Production Products] Loaded with data:', window.productsData);

        // Funkcje pomocnicze dla template
        function get_status_display(status) {
            const statusMap = {
                'czeka_na_wyciecie': 'Czeka na wyciƒôcie',
                'czeka_na_skladanie': 'Czeka na sk≈Çadanie',
                'czeka_na_pakowanie': 'Czeka na pakowanie',
                'spakowane': 'Spakowane',
                'wstrzymane': 'Wstrzymane'
            };
            return statusMap[status] || status || 'Nieznany';
        }

        // Inicjalizacja po za≈Çadowaniu DOM
        document.addEventListener('DOMContentLoaded', function() {
            initProductsList();
            updateProductsStats();

            {% if is_admin %}
            initDragAndDrop();
            {% endif %}
        });
    </script>

    <script src="{{ url_for('production.static', filename='js/priority-config.js') }}"></script>
</body>
</html>