<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Konfiguracja Produkcji - WoodPower CRM</title>
    <link rel="icon" href="{{ url_for('static', filename='images/favicon.png') }}" type="image/png">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('production.static', filename='css/production-panel.css') }}">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar systemowy -->
        {% include 'sidebar/sidebar.html' %}

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <div class="dashboard-header">
                <div class="header-top">
                    <h1 class="page-title title-with-underline">Konfiguracja Produkcji</h1>

                    <!-- Quick Actions Bar -->
                    <div class="quick-actions-bar">
                        <div class="quick-actions-list">
                            <a href="{{ url_for('production_main.dashboard') }}" class="quick-action-btn">
                                <span class="quick-action-icon">üè†</span>
                                Dashboard
                            </a>
                            <button id="save-config-btn" class="quick-action-btn" onclick="saveAllConfigurations()" disabled>
                                <span class="quick-action-icon">üíæ</span>
                                Zapisz Zmiany
                            </button>
                            <button id="reset-config-btn" class="quick-action-btn" onclick="resetToDefaults()">
                                <span class="quick-action-icon">üîÑ</span>
                                Przywr√≥ƒá Domy≈õlne
                            </button>
                            <button id="export-config-btn" class="quick-action-btn" onclick="exportConfiguration()">
                                <span class="quick-action-icon">üì§</span>
                                Eksport Konfiguracji
                            </button>
                        </div>
                    </div>

                    <div class="user-greeting">
                        <div class="config-status">
                            <span class="config-indicator" id="config-indicator">
                                <span class="status-dot"></span>
                            </span>
                            <span class="config-text" id="config-text">Konfiguracja za≈Çadowana</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Konfiguracja - Tabs -->
            <div class="config-container">
                <nav class="config-tabs">
                    <div class="nav nav-tabs" id="nav-tab" role="tablist">
                        <button class="nav-link active" id="priorities-tab" data-bs-toggle="tab"
                                data-bs-target="#priorities" type="button" role="tab">
                            üìå Priorytety
                        </button>
                        <button class="nav-link" id="system-tab" data-bs-toggle="tab"
                                data-bs-target="#system" type="button" role="tab">
                            ‚öôÔ∏è System
                        </button>
                        <button class="nav-link" id="security-tab" data-bs-toggle="tab"
                                data-bs-target="#security" type="button" role="tab">
                            üîí Zabezpieczenia
                        </button>
                        <button class="nav-link" id="sync-tab" data-bs-toggle="tab"
                                data-bs-target="#sync" type="button" role="tab">
                            üîÑ Synchronizacja
                        </button>
                        <button class="nav-link" id="cache-tab" data-bs-toggle="tab"
                                data-bs-target="#cache" type="button" role="tab">
                            üóÇÔ∏è Cache
                        </button>
                    </div>
                </nav>

                <div class="tab-content" id="nav-tabContent">
                    <!-- TAB: Konfiguracja Priorytet√≥w -->
                    <div class="tab-pane fade show active" id="priorities" role="tabpanel">
                        <div class="config-section">
                            <div class="config-section-header">
                                <h3>Kryteria Priorytet√≥w</h3>
                                <p class="text-muted">PrzeciƒÖgnij elementy aby zmieniƒá kolejno≈õƒá wa≈ºno≈õci kryteri√≥w</p>
                            </div>

                            <div class="priority-config-container">
                                <div class="priority-criteria-list" id="priority-criteria-list">
                                    {% if priority_configs %}
                                    {% for config in priority_configs %}
                                    <div class="priority-config-item"
                                         data-config-id="{{ config.id }}"
                                         data-original-weight="{{ config.weight_percentage }}"
                                         data-original-order="{{ config.display_order }}">
                                        <div class="priority-drag-handle">
                                            <span class="drag-icon">‚ãÆ‚ãÆ</span>
                                        </div>
                                        <div class="priority-config-content">
                                            <div class="priority-config-name">
                                                <h5>{{ config.config_name }}</h5>
                                                <p class="config-description">{{ config.description or 'Brak opisu' }}</p>
                                            </div>
                                            <div class="priority-config-controls">
                                                <label for="weight-{{ config.id }}">Waga (%):</label>
                                                <div class="weight-control">
                                                    <input type="range"
                                                           id="weight-{{ config.id }}"
                                                           class="form-range weight-slider"
                                                           min="0" max="100"
                                                           value="{{ config.weight_percentage }}"
                                                           oninput="updateWeightValue(this, {{ config.id }})">
                                                    <span class="weight-value" id="weight-value-{{ config.id }}">{{ config.weight_percentage }}%</span>
                                                </div>
                                                <div class="priority-config-actions">
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox"
                                                               id="active-{{ config.id }}"
                                                               {{ 'checked' if config.is_active else '' }}
                                                               onchange="toggleCriterion({{ config.id }}, this.checked)">
                                                        <label class="form-check-label" for="active-{{ config.id }}">
                                                            Aktywne
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                    {% else %}
                                    <div class="no-priorities">
                                        <p class="text-muted">Brak skonfigurowanych kryteri√≥w priorytet√≥w</p>
                                        <button class="btn btn-primary" onclick="createDefaultPriorities()">
                                            Utw√≥rz Domy≈õlne Kryteria
                                        </button>
                                    </div>
                                    {% endif %}
                                </div>

                                <div class="priority-config-summary">
                                    <h6>Podsumowanie wag</h6>
                                    <div class="weight-summary" id="weight-summary">
                                        <div class="total-weight">
                                            <span class="summary-label">Suma wag:</span>
                                            <span class="summary-value" id="total-weight">0%</span>
                                        </div>
                                        <div class="weight-status" id="weight-status">
                                            <span class="status-message">Obliczanie...</span>
                                        </div>
                                    </div>

                                    <div class="priority-actions">
                                        <button class="btn btn-outline-primary" onclick="addNewCriterion()">
                                            ‚ûï Dodaj Kryterium
                                        </button>
                                        <button class="btn btn-outline-warning" onclick="normalizeWeights()">
                                            ‚öñÔ∏è Normalizuj Wagi
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TAB: Ustawienia Systemowe -->
                    <div class="tab-pane fade" id="system" role="tabpanel">
                        <div class="config-section">
                            <div class="config-section-header">
                                <h3>Ustawienia Systemowe</h3>
                                <p class="text-muted">Podstawowe ustawienia modu≈Çu produkcji</p>
                            </div>

                            <div class="config-groups">
                                <!-- Od≈õwie≈ºanie Interfejs√≥w -->
                                <div class="config-group">
                                    <h5 class="config-group-title">Czƒôstotliwo≈õƒá Od≈õwie≈ºania</h5>
                                    <div class="config-items">
                                        <div class="config-item">
                                            <label for="refresh-interval" class="form-label">
                                                Interwa≈Ç od≈õwie≈ºania interfejs√≥w stanowisk (sekundy):
                                            </label>
                                            <div class="input-group">
                                                <input type="number"
                                                       class="form-control"
                                                       id="refresh-interval"
                                                       min="5" max="300" step="5"
                                                       value="{{ configs.REFRESH_INTERVAL_SECONDS.value or 30 }}"
                                                       oninput="validateRefreshInterval(this)">
                                                <span class="input-group-text">sek</span>
                                            </div>
                                            <div class="form-text">
                                                Aktualnie: od≈õwie≈ºanie co <span id="current-refresh">{{ configs.REFRESH_INTERVAL_SECONDS.value or 30 }}</span> sekund
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Debug i Logowanie -->
                                <div class="config-group">
                                    <h5 class="config-group-title">Debug i Logowanie</h5>
                                    <div class="config-items">
                                        <div class="config-item">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox"
                                                       id="debug-backend"
                                                       {{ 'checked' if configs.DEBUG_PRODUCTION_BACKEND.value == 'True' else '' }}
                                                       onchange="updateConfigValue('DEBUG_PRODUCTION_BACKEND', this.checked ? 'True' : 'False')">
                                                <label class="form-check-label" for="debug-backend">
                                                    <strong>Debug Backend</strong>
                                                    <small class="text-muted d-block">Szczeg√≥≈Çowe logowanie operacji backend</small>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="config-item">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox"
                                                       id="debug-frontend"
                                                       {{ 'checked' if configs.DEBUG_PRODUCTION_FRONTEND.value == 'True' else '' }}
                                                       onchange="updateConfigValue('DEBUG_PRODUCTION_FRONTEND', this.checked ? 'True' : 'False')">
                                                <label class="form-check-label" for="debug-frontend">
                                                    <strong>Debug Frontend</strong>
                                                    <small class="text-muted d-block">Console.log dla interfejs√≥w JavaScript</small>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Limity Systemu -->
                                <div class="config-group">
                                    <h5 class="config-group-title">Limity Systemu</h5>
                                    <div class="config-items">
                                        <div class="config-item">
                                            <label for="max-items-sync" class="form-label">
                                                Maksymalna liczba element√≥w na synchronizacjƒô:
                                            </label>
                                            <input type="number"
                                                   class="form-control"
                                                   id="max-items-sync"
                                                   min="10" max="5000" step="10"
                                                   value="{{ configs.PRODUCTION_MAX_ITEMS_PER_SYNC.value or 1000 }}"
                                                   oninput="updateConfigValue('PRODUCTION_MAX_ITEMS_PER_SYNC', this.value)">
                                            <div class="form-text">
                                                Zbyt du≈ºa warto≈õƒá mo≈ºe spowolniƒá synchronizacjƒô
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TAB: Zabezpieczenia -->
                    <div class="tab-pane fade" id="security" role="tabpanel">
                        <div class="config-section">
                            <div class="config-section-header">
                                <h3>Zabezpieczenia IP</h3>
                                <p class="text-muted">ZarzƒÖdzanie dozwolonymi adresami IP dla stanowisk produkcyjnych</p>
                            </div>

                            <div class="security-config">
                                <div class="ip-whitelist-section">
                                    <h5>Dozwolone adresy IP</h5>
                                    <div class="ip-list" id="ip-list">
                                        {% set allowed_ips = configs.STATION_ALLOWED_IPS.value.split(',') if configs.STATION_ALLOWED_IPS.value else [] %}
                                        {% for ip in allowed_ips %}
                                        {% if ip.strip() %}
                                        <div class="ip-item" data-ip="{{ ip.strip() }}">
                                            <span class="ip-address">{{ ip.strip() }}</span>
                                            <div class="ip-actions">
                                                <button class="btn btn-sm btn-outline-primary"
                                                        onclick="testIPAccess('{{ ip.strip() }}')">
                                                    üîç Test
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger"
                                                        onclick="removeIP('{{ ip.strip() }}')">
                                                    üóëÔ∏è Usu≈Ñ
                                                </button>
                                            </div>
                                        </div>
                                        {% endif %}
                                        {% endfor %}

                                        {% if not allowed_ips or not allowed_ips[0].strip() %}
                                        <div class="no-ips">
                                            <p class="text-muted">Brak skonfigurowanych adres√≥w IP</p>
                                        </div>
                                        {% endif %}
                                    </div>

                                    <div class="add-ip-section">
                                        <div class="input-group">
                                            <input type="text"
                                                   class="form-control"
                                                   id="new-ip"
                                                   placeholder="192.168.1.100"
                                                   pattern="^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$"
                                                   onkeypress="if(event.key==='Enter') addNewIP()">
                                            <button class="btn btn-primary" onclick="addNewIP()">
                                                ‚ûï Dodaj IP
                                            </button>
                                        </div>
                                        <div class="form-text">
                                            Format: 192.168.1.100 (IPv4)
                                        </div>
                                    </div>
                                </div>

                                <div class="security-info">
                                    <h6>Informacje o zabezpieczeniach</h6>
                                    <div class="info-cards">
                                        <div class="info-card">
                                            <div class="info-icon">üõ°Ô∏è</div>
                                            <div class="info-content">
                                                <h6>Ochrona Stanowisk</h6>
                                                <p>Tylko adresy z bia≈Çej listy mogƒÖ uzyskaƒá dostƒôp do interfejs√≥w stanowisk</p>
                                            </div>
                                        </div>
                                        <div class="info-card">
                                            <div class="info-icon">üåê</div>
                                            <div class="info-content">
                                                <h6>Panel Administracyjny</h6>
                                                <p>Panel konfiguracji wymaga logowania i roli administratora</p>
                                            </div>
                                        </div>
                                        <div class="info-card">
                                            <div class="info-icon">üîê</div>
                                            <div class="info-content">
                                                <h6>CRON Security</h6>
                                                <p>Synchronizacja CRON zabezpieczona tajnym kluczem</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TAB: Synchronizacja -->
                    <div class="tab-pane fade" id="sync" role="tabpanel">
                        <div class="config-section">
                            <div class="config-section-header">
                                <h3>Ustawienia Synchronizacji</h3>
                                <p class="text-muted">Konfiguracja synchronizacji z Baselinker</p>
                            </div>

                            <div class="sync-config">
                                <div class="sync-status-card">
                                    <h5>Status Synchronizacji</h5>
                                    <div class="sync-status-content" id="sync-status-content">
                                        <div class="status-loading">≈Åadowanie statusu...</div>
                                    </div>
                                </div>

                                <div class="sync-settings">
                                    <h5>Ustawienia CRON</h5>
                                    <div class="config-items">
                                        <div class="config-item">
                                            <label for="sync-interval" class="form-label">
                                                Interwa≈Ç synchronizacji (sekundy):
                                            </label>
                                            <input type="number"
                                                   class="form-control"
                                                   id="sync-interval"
                                                   min="300" max="86400" step="300"
                                                   value="{{ configs.PRODUCTION_SYNC_INTERVAL.value or 3600 }}"
                                                   oninput="updateConfigValue('PRODUCTION_SYNC_INTERVAL', this.value)">
                                            <div class="form-text">
                                                Aktualnie: synchronizacja co <span id="current-sync-interval">{{ (configs.PRODUCTION_SYNC_INTERVAL.value|int / 60) or 60 }}</span> minut
                                            </div>
                                        </div>

                                        <div class="config-item">
                                            <label for="cron-secret" class="form-label">
                                                CRON Secret Key:
                                            </label>
                                            <div class="input-group">
                                                <input type="password"
                                                       class="form-control"
                                                       id="cron-secret"
                                                       value="{{ configs.PRODUCTION_CRON_SECRET.value or '' }}"
                                                       readonly>
                                                <button class="btn btn-outline-secondary"
                                                        onclick="toggleSecretVisibility()">
                                                    üëÅÔ∏è
                                                </button>
                                                <button class="btn btn-warning"
                                                        onclick="regenerateSecret()">
                                                    üîÑ Nowy Klucz
                                                </button>
                                            </div>
                                            <div class="form-text">
                                                Tajny klucz dla zabezpieczenia endpoint√≥w CRON
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="sync-actions">
                                    <h5>Akcje Synchronizacji</h5>
                                    <div class="action-buttons">
                                        <button class="btn btn-primary" onclick="triggerManualSync()">
                                            üîÑ Uruchom Synchronizacjƒô
                                        </button>
                                        <button class="btn btn-info" onclick="checkSyncHealth()">
                                            üè• Sprawd≈∫ Health
                                        </button>
                                        <button class="btn btn-warning" onclick="clearSyncErrors()">
                                            üßπ Wyczy≈õƒá B≈Çƒôdy
                                        </button>
                                        <button class="btn btn-outline-secondary" onclick="viewSyncLogs()">
                                            üìã Zobacz Logi
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TAB: Cache -->
                    <div class="tab-pane fade" id="cache" role="tabpanel">
                        <div class="config-section">
                            <div class="config-section-header">
                                <h3>ZarzƒÖdzanie Cache</h3>
                                <p class="text-muted">Konfiguracja i monitoring systemu cache</p>
                            </div>

                            <div class="cache-config">
                                <div class="cache-stats" id="cache-stats">
                                    <div class="stats-loading">≈Åadowanie statystyk cache...</div>
                                </div>

                                <div class="cache-settings">
                                    <h5>Ustawienia Cache</h5>
                                    <div class="config-items">
                                        <div class="config-item">
                                            <label for="cache-duration" class="form-label">
                                                Czas ≈ºycia cache priorytet√≥w (sekundy):
                                            </label>
                                            <input type="number"
                                                   class="form-control"
                                                   id="cache-duration"
                                                   min="60" max="86400" step="60"
                                                   value="{{ configs.CACHE_DURATION_SECONDS.value or 3600 }}"
                                                   oninput="updateConfigValue('CACHE_DURATION_SECONDS', this.value)">
                                            <div class="form-text">
                                                Aktualnie: cache wa≈ºny przez <span id="current-cache-duration">{{ (configs.CACHE_DURATION_SECONDS.value|int / 60) or 60 }}</span> minut
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="cache-actions">
                                    <h5>Akcje Cache</h5>
                                    <div class="action-buttons">
                                        <button class="btn btn-warning" onclick="clearAllCache()">
                                            üßπ Wyczy≈õƒá Ca≈Çy Cache
                                        </button>
                                        <button class="btn btn-info" onclick="refreshCacheStats()">
                                            üìä Od≈õwie≈º Statystyki
                                        </button>
                                        <button class="btn btn-outline-primary" onclick="preloadCache()">
                                            ‚ö° Preload Cache
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal potwierdzenia -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmModalTitle">Potwierdzenie</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="confirmModalBody">
                    <!-- Zawarto≈õƒá dynamiczna -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                    <button type="button" class="btn btn-primary" id="confirmModalAction">Potwierd≈∫</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal dodawania kryterium -->
    <div class="modal fade" id="addCriterionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Dodaj Nowe Kryterium Priorytetu</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addCriterionForm">
                        <div class="mb-3">
                            <label for="criterionName" class="form-label">Nazwa kryterium:</label>
                            <input type="text" class="form-control" id="criterionName" required>
                        </div>
                        <div class="mb-3">
                            <label for="criterionDescription" class="form-label">Opis:</label>
                            <textarea class="form-control" id="criterionDescription" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="criterionWeight" class="form-label">Waga poczƒÖtkowa (%):</label>
                            <input type="number" class="form-control" id="criterionWeight" min="0" max="100" value="10">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                    <button type="button" class="btn btn-primary" onclick="saveNewCriterion()">Dodaj</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Skrypty -->
    <script src="{{ url_for('static', filename='js/sidebar.js') }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <script>
        // Przekazujemy dane z backendu do JavaScript
        window.configData = {
            configs: {{ configs|tojson if configs else {}|tojson }},
            priorityConfigs: {{ priority_configs|tojson if priority_configs else []|tojson }}
        };

        window.currentUser = {
            role: '{{ current_user.role if current_user.is_authenticated else "guest" }}',
            id: {{ current_user.id if current_user.is_authenticated else 'null' }}
        };

        console.log('[Production Config] Loaded with data:', window.configData);

        // Inicjalizacja po za≈Çadowaniu DOM
        document.addEventListener('DOMContentLoaded', function() {
            initConfigPanel();
            initPrioritiesDragDrop();
            loadSyncStatus();
            loadCacheStats();
            updateWeightSummary();
        });
    </script>

    <script src="{{ url_for('production.static', filename='js/config-management.js') }}"></script>
</body>
</html>