<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Licznik czasu - Stanowiska sklejania</title>
    <link rel="icon" href="{{ url_for('static', filename='images/favicon.png') }}" type="image/png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            font-family: 'Courier New',monospace;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
            min-height: 100vh
        }

        .header {
            text-align: center;
            margin-bottom: 30px
        }

            .header h1 {
                font-size: 2.5rem;
                color: #00ff00;
                text-shadow: 0 0 10px #00ff00
            }

        .machine {
            margin-bottom: 20px;
            border: 2px solid #333;
            border-radius: 15px;
            padding: 15px;
            background: linear-gradient(135deg,#2a2a2a,#1a1a1a);
            height: calc(50vh - 40px);
            display: flex;
            flex-direction: column
        }

        .machine-title {
            font-family: 'Franklin Gothic Medium','Arial Narrow',Arial,sans-serif;
            font-size: 2rem;
            color: #fff;
            text-align: center;
            margin-bottom: 15px
        }

        .stations-container {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 15px;
            flex: 1
        }

        .station {
            flex: 1;
            min-height: 200px;
            height: auto;
            border: 3px solid #555;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all .3s ease;
        }

            .station.inactive {
                background: #666;
                border-color: #888
            }

            .station.active-blue {
                background: #06c;
                border-color: #08f;
                box-shadow: 0 0 20px rgba(0,136,255,.5)
            }

            .station.active-yellow {
                background: #cc9900;
                border-color: #ffcc00;
                box-shadow: 0 0 20px rgba(255,204,0,.5)
            }

            .station.active-red {
                background: #c00;
                border-color: #f00;
                box-shadow: 0 0 20px rgba(255,0,0,.5);
                animation: pulse-red 1s infinite
            }

            .station.combined {
                flex: 2
            }

        @keyframes pulse-red {
            0%,100% {
                opacity: 1
            }

            50% {
                opacity: .7
            }
        }

        .station-label {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 10px;
            background-color: #fff;
            padding: 6px 25px;
            border-radius: 8px;
            color: #000;
            font-family: 'Courier New',monospace;
        }

        .timer-display {
            font-size: 10rem;
            font-weight: bold;
            font-family: 'Courier New',monospace;
            text-shadow: 0 0 5px rgba(0,0,0,.8);
            color: #fff
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            justify-content: center
        }

        .controls-row, .controls-combined {
            display: flex;
            gap: 20px;
            justify-content: center
        }

        .btn {
            padding: 15px 25px;
            font-size: 3rem;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all .3s ease;
            font-family: 'Courier New',monospace;
            min-width: 60px
        }

        .btn-individual {
            background: #4CAF50;
            color: #fff;
            flex: 1;
            min-height: 100px
        }

        .btn-combined {
            background: #2196F3;
            color: #fff;
            min-height: 100px;
            flex: 1
        }

        .btn-stop {
            background: #f44336 !important;
            color: #fff
        }

        .btn:disabled {
            opacity: .5;
            cursor: not-allowed;
            transform: none
        }

        .status-bar {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,.8);
            padding: 10px;
            border-radius: 5px;
            font-size: .9rem
        }

        /* stary STOP w kaflach wyłączony całkowicie */
        .stop-button {
            display: none !important
        }

        /* Responsywność */
        @media (max-width:768px) {
            .machine {
                height: calc(50vh - 20px)
            }

            .stations-container {
                flex-direction: column;
                align-items: center
            }

            .station {
                max-width: none;
                width: 100%;
                min-height: 150px
            }

                .station.combined {
                    max-width: none;
                    width: 100%
                }

            .controls-row, .controls-combined {
                flex-wrap: wrap
            }

            .timer-display {
                font-size: 2.5rem
            }
        }
    </style>
</head>
<body>
    <div class="status-bar">
        <div id="currentTime"></div>
        <div>Aktywne timery: <span id="activeCount">0</span></div>
    </div>

    <!-- MASZYNA 1 -->
    <div class="machine" id="machine1">
        <div class="machine-title">MASZYNA 1</div>
        <div class="stations-container" id="machine1-stations">
            <div class="station inactive" id="m1-s1" data-machine="1" data-station="1">
                <div class="station-label">M1-S1</div>
                <div class="timer-display" id="timer-m1-s1">Gotowe</div>
                <button class="stop-button" onclick="stopTimer('m1-s1')">STOP</button>
            </div>
            <div class="station inactive" id="m1-s2" data-machine="1" data-station="2">
                <div class="station-label">M1-S2</div>
                <div class="timer-display" id="timer-m1-s2">Gotowe</div>
                <button class="stop-button" onclick="stopTimer('m1-s2')">STOP</button>
            </div>
            <div class="station inactive" id="m1-s3" data-machine="1" data-station="3">
                <div class="station-label">M1-S3</div>
                <div class="timer-display" id="timer-m1-s3">Gotowe</div>
                <button class="stop-button" onclick="stopTimer('m1-s3')">STOP</button>
            </div>
        </div>

        <div class="controls">
            <div class="controls-row">
                <button class="btn btn-individual" data-machine="1" data-stations="m1-s1">1</button>
                <button class="btn btn-individual" data-machine="1" data-stations="m1-s2">2</button>
                <button class="btn btn-individual" data-machine="1" data-stations="m1-s3">3</button>
            </div>
            <div class="controls-combined">
                <button class="btn btn-combined" data-machine="1" data-stations="m1-s1,m1-s2">1+2</button>
                <button class="btn btn-combined" data-machine="1" data-stations="m1-s2,m1-s3">2+3</button>
            </div>
        </div>
    </div>

    <!-- MASZYNA 2 -->
    <div class="machine" id="machine2">
        <div class="machine-title">MASZYNA 2</div>
        <div class="stations-container" id="machine2-stations">
            <div class="station inactive" id="m2-s1" data-machine="2" data-station="1">
                <div class="station-label">M2-S1</div>
                <div class="timer-display" id="timer-m2-s1">Gotowe</div>
                <button class="stop-button" onclick="stopTimer('m2-s1')">STOP</button>
            </div>
            <div class="station inactive" id="m2-s2" data-machine="2" data-station="2">
                <div class="station-label">M2-S2</div>
                <div class="timer-display" id="timer-m2-s2">Gotowe</div>
                <button class="stop-button" onclick="stopTimer('m2-s2')">STOP</button>
            </div>
            <div class="station inactive" id="m2-s3" data-machine="2" data-station="3">
                <div class="station-label">M2-S3</div>
                <div class="timer-display" id="timer-m2-s3">Gotowe</div>
                <button class="stop-button" onclick="stopTimer('m2-s3')">STOP</button>
            </div>
        </div>

        <div class="controls">
            <div class="controls-row">
                <button class="btn btn-individual" data-machine="2" data-stations="m2-s1">1</button>
                <button class="btn btn-individual" data-machine="2" data-stations="m2-s2">2</button>
                <button class="btn btn-individual" data-machine="2" data-stations="m2-s3">3</button>
            </div>
            <div class="controls-combined">
                <button class="btn btn-combined" data-machine="2" data-stations="m2-s1,m2-s2">1+2</button>
                <button class="btn btn-combined" data-machine="2" data-stations="m2-s2,m2-s3">2+3</button>
            </div>
        </div>
    </div>

    <!-- DŹWIĘKI -->
    <audio id="alarmSound" preload="auto" loop>
        <source src="/production/static/sounds/alarm.mp3" type="audio/mpeg" />
    </audio>
    <audio id="beepSound" preload="auto">
        <source src="/production/static/sounds/beep.mp3" type="audio/mpeg" />
    </audio>

    <script>
        // ------------------------------
        // STAN APLIKACJI
        // ------------------------------
        const timers = new Map();             // stationId -> {startTime,isRunning,combined,combinedWith}
        const TIMER_DURATION = 2 * 60;      // 2 min (zmień na 20*60 w produkcji)
        const YELLOW_THRESHOLD = 1 * 60;      // żółty od 1 minuty do zera
        let alarmPlaying = false;
        const yellowSoundPlayed = new Set();  // które stacje już "zapikały" na żółtym

        // ------------------------------
        // NARZĘDZIA
        // ------------------------------
        function updateClock() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('pl-PL');
        }

        function updateActiveCount() {
            document.getElementById('activeCount').textContent = timers.size;
        }

        function formatTime(seconds) {
            const mins = Math.floor(Math.abs(seconds) / 60);
            const secs = Math.abs(seconds) % 60;
            const sign = seconds < 0 ? '-' : '';
            return `${sign}${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function stationsFromBtn(btn) {
            return (btn.dataset.stations || '').split(',').filter(Boolean);
        }

        function machineOfStation(stationId) {
            // "m1-s2" -> "1"
            return stationId.split('-')[0].replace('m', '');
        }

        function buttonsInMachine(machineId) {
            const scope = document.getElementById(`machine${machineId}`);
            return Array.from(scope.querySelectorAll('.btn'));
        }

        function busyStationsForMachine(machineId) {
            const set = new Set();
            timers.forEach((val, stationId) => {
                if (machineOfStation(stationId) === String(machineId)) set.add(stationId);
            });
            return set;
        }

        // ------------------------------
        // LOCAL STORAGE
        // ------------------------------
        function saveTimersToStorage() {
            const timersData = {};
            timers.forEach((t, stationId) => {
                timersData[stationId] = {
                    startTime: t.startTime,
                    isRunning: t.isRunning,
                    combined: t.combined || false,
                    combinedWith: t.combinedWith || null
                };
            });
            localStorage.setItem('productionTimers', JSON.stringify({
                data: timersData,
                timestamp: Date.now(),
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
            }));
        }

        function clearTimersFromStorage() {
            localStorage.removeItem('productionTimers');
        }

        function loadTimersFromStorage() {
            const stored = localStorage.getItem('productionTimers');
            if (!stored) return;
            try {
                const { data } = JSON.parse(stored);
                const now = Date.now();
                Object.entries(data).forEach(([stationId, t]) => {
                    if (t.isRunning) {
                        // odtwarzamy stan
                        timers.set(stationId, {
                            startTime: t.startTime,
                            isRunning: true,
                            combined: !!t.combined,
                            combinedWith: t.combinedWith || null
                        });

                        // odtwórz wygląd stacji (bez przycisków STOP w kaflach)
                        const station = document.getElementById(stationId);
                        station.classList.remove('inactive');
                        station.classList.add('active-blue');

                        if (t.combined && t.combinedWith) {
                            combineStations(stationId, t.combinedWith);
                        }
                    }
                });
                console.log(`Przywrócono ${timers.size} timerów z localStorage`);
            } catch (e) {
                console.error('Błąd podczas ładowania timerów:', e);
                localStorage.removeItem('productionTimers');
            }
        }

        // ------------------------------
        // DŹWIĘKI + LOGI
        // ------------------------------
        function setupAudioLogging() {
            const alarm = document.getElementById('alarmSound');
            const beep = document.getElementById('beepSound');

            if (!alarm) { console.warn("❌ [AUDIO] #alarmSound nie znaleziony w DOM"); }
            if (!beep) { console.warn("❌ [AUDIO] #beepSound nie znaleziony w DOM"); }

            // Jednorazowe logi po załadowaniu źródeł
            [['ALARM', alarm], ['BEEP', beep]].forEach(([label, el]) => {
                if (!el) return;
                const onLoaded = () => console.log(`✅ [${label}] Załadowano źródło: ${el.currentSrc || '(brak currentSrc)'}; readyState=${el.readyState}`);
                const onError = (e) => console.error(`❌ [${label}] Błąd ładowania audio`, e);

                // jeśli już jest w cache / gotowe
                if (el.readyState > 0) {
                    onLoaded();
                } else {
                    el.addEventListener('loadeddata', onLoaded, { once: true });
                    el.addEventListener('canplaythrough', onLoaded, { once: true });
                }
                el.addEventListener('error', onError);
            });
        }

        function playAlarm() {
            const audio = document.getElementById('alarmSound');
            if (!audio) { console.warn("❌ [ALARM] #alarmSound brak"); return; }

            console.log(`🔊 [ALARM] Próba startu. src=${audio.currentSrc || '(brak)'} loop=${audio.loop}`);
            if (!alarmPlaying) {
                audio.loop = true;
                audio.play()
                    .then(() => {
                        alarmPlaying = true;
                        console.log("✅ [ALARM] Odtwarzanie w pętli rozpoczęte");
                    })
                    .catch(e => console.error("❌ [ALARM] Nie można odtworzyć:", e));
            }
        }

        function stopAlarmIfNeeded() {
            let hasRed = false;
            timers.forEach(t => {
                const remaining = TIMER_DURATION - Math.floor((Date.now() - t.startTime) / 1000);
                if (remaining < 0) hasRed = true;
            });

            if (!hasRed && alarmPlaying) {
                const audio = document.getElementById('alarmSound');
                if (audio) {
                    audio.pause();
                    audio.currentTime = 0;
                    console.log("⏹️ [ALARM] Zatrzymano alarm (brak czerwonych)");
                }
                alarmPlaying = false;
            }
        }

        // Jednorazowy 'beep' na żółtym dla danej stacji
        function playYellowBeepOnce(stationId) {
            if (yellowSoundPlayed.has(stationId)) return;

            const beep = document.getElementById('beepSound');
            if (!beep) {
                console.warn("❌ [BEEP] #beepSound brak");
                return;
            }

            console.log(`🔔 [BEEP] Start piknięcia (stacja ${stationId}). src=${beep.currentSrc || '(brak)'}`);
            try {
                beep.currentTime = 0;
                beep.play()
                    .then(() => {
                        console.log(`✅ [BEEP] Piknięcie odtworzone (stacja ${stationId}) — pełny plik`);
                    })
                    .catch(e => console.error("❌ [BEEP] Nie można odtworzyć:", e));
            } catch (err) {
                console.error("❌ [BEEP] Wyjątek podczas odtwarzania:", err);
            }

            yellowSoundPlayed.add(stationId);
        }


        // ------------------------------
        // PRZYCISKI – TEKST I BLOKADY
        // ------------------------------
        function isButtonActive(btn) {
            const st = stationsFromBtn(btn);
            if (st.length === 1) {
                const t = timers.get(st[0]);
                return !!(t && t.isRunning && !t.combined);
            } else if (st.length === 2) {
                const [a, b] = st;
                const t1 = timers.get(a), t2 = timers.get(b);
                return !!(t1 && t2 && t1.combined && t2.combined && t1.combinedWith === b && t2.combinedWith === a);
            }
            return false;
        }

        function setButtonVisual(btn, active) {
            const label = btn.dataset.label || btn.textContent.trim();
            if (active) {
                btn.classList.add('btn-stop');
                btn.textContent = `STOP - ${label}`;
            } else {
                btn.classList.remove('btn-stop');
                btn.textContent = label;
            }
        }

        function refreshButtonsForMachine(machineId) {
            const btns = buttonsInMachine(machineId);
            // ustaw dataset.label, jeśli brak
            btns.forEach(b => { if (!b.dataset.label) { b.dataset.label = b.textContent.trim(); } });

            // na podstawie timerów ustaw ACTIVE i DISABLED
            const busy = busyStationsForMachine(machineId);

            btns.forEach(btn => {
                const st = stationsFromBtn(btn);
                const intersects = st.some(s => busy.has(s));
                const active = isButtonActive(btn);

                setButtonVisual(btn, active);

                if (active) {
                    btn.disabled = false; // aktywny zawsze klikany by zatrzymać
                } else {
                    // blokuj tylko jeśli konfliktuje ze stacją używaną przez INNEGO aktywnego przycisku
                    btn.disabled = intersects;
                }
            });
        }

        function refreshAllButtons() {
            refreshButtonsForMachine(1);
            refreshButtonsForMachine(2);
        }

        // ------------------------------
        // START / STOP TIMERÓW
        // ------------------------------
        function startTimer(stationId) {
            if (timers.has(stationId)) return; // już działa

            const timer = { startTime: Date.now(), isRunning: true, combined: false, combinedWith: null };
            timers.set(stationId, timer);

            const stationEl = document.getElementById(stationId);
            stationEl.classList.remove('inactive');
            stationEl.classList.remove('active-yellow', 'active-red');
            stationEl.classList.add('active-blue');

            updateActiveCount();
            saveTimersToStorage();
            console.log(`Timer rozpoczęty dla ${stationId}`);
        }

        function startCombinedTimer(aId, bId) {
            // jeśli któryś zajęty — nie startujemy (przycisk i tak będzie zablokowany)
            if (timers.has(aId) || timers.has(bId)) return;

            const now = Date.now();
            timers.set(aId, { startTime: now, isRunning: true, combined: true, combinedWith: bId });
            timers.set(bId, { startTime: now, isRunning: true, combined: true, combinedWith: aId });

            combineStations(aId, bId);

            updateActiveCount();
            saveTimersToStorage();
            console.log(`Połączony timer rozpoczęty dla ${aId}+${bId}`);
        }

        function stopTimer(stationId) {
            const t = timers.get(stationId);
            if (!t) return;

            if (t.combined && t.combinedWith) {
                const other = t.combinedWith;
                timers.delete(stationId);
                timers.delete(other);

                uncombineStations(stationId, other);

                [stationId, other].forEach(id => {
                    const el = document.getElementById(id);
                    const display = el.querySelector('.timer-display');
                    el.className = 'station inactive';
                    display.textContent = 'Gotowe';
                    yellowSoundPlayed.delete(id);
                });
            } else {
                timers.delete(stationId);
                const el = document.getElementById(stationId);
                const display = el.querySelector('.timer-display');
                el.className = 'station inactive';
                display.textContent = 'Gotowe';
                yellowSoundPlayed.delete(stationId);
            }

            updateActiveCount();
            if (timers.size === 0) clearTimersFromStorage(); else saveTimersToStorage();
            stopAlarmIfNeeded();
            refreshAllButtons();
            console.log(`Timer zatrzymany dla ${stationId}`);
        }

        // ------------------------------
        // WIZUALNE ŁĄCZENIE / ROZŁĄCZANIE
        // ------------------------------
        function combineStations(aId, bId) {
            const a = document.getElementById(aId);
            const b = document.getElementById(bId);

            // ukryj B, poszerz A
            b.style.display = 'none';
            a.classList.add('combined');
            a.classList.remove('inactive', 'active-yellow', 'active-red');
            a.classList.add('active-blue');

            // zmień label A -> A+nrB
            const la = a.querySelector('.station-label');
            const lb = b.querySelector('.station-label');
            const origA = la.textContent;               // np. "M1-S1"
            const suffixB = lb.textContent.split('-')[1]; // "S2"
            la.textContent = `${origA}+${suffixB}`;
        }

        function uncombineStations(aId, bId) {
            const a = document.getElementById(aId);
            const b = document.getElementById(bId);

            b.style.display = 'flex';
            a.classList.remove('combined');

            // przywróć label A do formatu "M1-S1"
            const la = a.querySelector('.station-label');
            la.textContent = aId.toUpperCase().replace('-', '-');
        }

        // ------------------------------
        // PĘTLE AKTUALIZACJI
        // ------------------------------
        function updateTimers() {
            const now = Date.now();
            let hasRed = false;

            timers.forEach((t, stationId) => {
                const elapsed = Math.floor((now - t.startTime) / 1000);
                const remaining = TIMER_DURATION - elapsed;
                const display = document.getElementById(`timer-${stationId}`);
                const station = document.getElementById(stationId);

                display.textContent = formatTime(remaining);
                station.classList.remove('active-blue', 'active-yellow', 'active-red');

                if (remaining > YELLOW_THRESHOLD) {
                    station.classList.add('active-blue');
                } else if (remaining > 0) {
                    station.classList.add('active-yellow');
                    playYellowBeepOnce(stationId);
                } else {
                    station.classList.add('active-red');
                    hasRed = true;
                }
            });

            if (hasRed && !alarmPlaying) playAlarm();
            if (!hasRed && alarmPlaying) stopAlarmIfNeeded();
        }

        // ------------------------------
        // OBSŁUGA KLIKNIĘĆ PRZYCISKÓW
        // ------------------------------
        function onButtonClick(e) {
            const btn = e.currentTarget;
            const st = stationsFromBtn(btn);

            // jeśli aktywny — STOP
            if (isButtonActive(btn)) {
                if (st.length === 1) {
                    stopTimer(st[0]);
                } else if (st.length === 2) {
                    // wystarczy zatrzymać jeden, zatrzyma oba
                    stopTimer(st[0]);
                }
                setButtonVisual(btn, false);
                refreshAllButtons();
                return;
            }

            // jeśli nieaktywny, ale konfliktuje — ignoruj (powinien być disabled)
            const machineId = machineOfStation(st[0]);
            const busy = busyStationsForMachine(machineId);
            const conflict = st.some(s => busy.has(s));
            if (conflict) return;

            // start
            if (st.length === 1) {
                startTimer(st[0]);
            } else if (st.length === 2) {
                startCombinedTimer(st[0], st[1]);
            }
            setButtonVisual(btn, true);
            refreshAllButtons();
        }

        // ------------------------------
        // INICJALIZACJA
        // ------------------------------
        function init() {
            console.log('🚀 Inicjalizacja aplikacji licznika czasu');

            // przypnij listener do wszystkich przycisków i zapamiętaj ich etykiety
            document.querySelectorAll('.btn').forEach(btn => {
                if (!btn.dataset.label) btn.dataset.label = btn.textContent.trim();
                btn.addEventListener('click', onButtonClick);
            });

            setupAudioLogging();

            // odtwórz timery z localStorage
            loadTimersFromStorage();

            // zsynchronizuj przyciski po odtworzeniu timerów
            refreshAllButtons();

            // pętle
            setInterval(updateClock, 1000);
            setInterval(updateTimers, 1000);
            setInterval(saveTimersToStorage, 5000);

            // pierwsze odświeżenia
            updateClock();
            updateActiveCount();

            window.addEventListener('beforeunload', saveTimersToStorage);
            console.log(`✅ Aplikacja gotowa. Załadowano ${timers.size} timerów.`);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
